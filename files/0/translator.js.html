<h1>translator.js</h1>
<pre><code class="lang-js"><span class="comment">/**
 * Matsumura Rohai
 * Translate PO files with the help of Microsoft Translate API
 */</span>
<span class="string">'use strict'</span>;

<span class="keyword">var</span> Gettext = require(<span class="string">'node-gettext'</span>);
<span class="keyword">var</span> MsTranslator = require(<span class="string">'mstranslator'</span>);

<span class="keyword">var</span> gt = <span class="keyword">new</span> Gettext();
<span class="keyword">var</span> translateClient;

<span class="comment">// When was the token last time received, unix time</span>
<span class="keyword">var</span> lastTokenTime = <span class="number">0</span>;

<span class="comment">/**
 * Initialises the API client
 * @returns {void}
 */</span>
<span class="keyword">var</span> init = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  translateClient = <span class="keyword">new</span> MsTranslator({
    client_id: global.api_key,
    client_secret: global.api_secret
  });
};

<span class="comment">/**
 *
 * @param {string} from
 * @param {string} to
 * @param {string} text
 * @param {function} translateCallback
 * @returns {void}
 */</span>
<span class="keyword">var</span> translate = <span class="function"><span class="keyword">function</span> <span class="params">(from, to, text, translateCallback)</span> {</span>
  <span class="keyword">var</span> now = Math.round(Date.now() / <span class="number">1000</span>); <span class="comment">// instead of ms, just full seconds</span>
  <span class="keyword">var</span> params = {
    text: text,
    from: from,
    to: to
  };
  <span class="comment">// If token is older than 9 minutes, refresh it first</span>
  <span class="keyword">if</span> (now > <span class="number">540</span> + lastTokenTime) {
    translateClient.initialize_token(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      lastTokenTime = now;
      translateClient.translate(params, <span class="function"><span class="keyword">function</span> <span class="params">(err, data)</span> {</span>
        translateCallback(data);
      });
    });
  }
  <span class="keyword">else</span> {
    <span class="comment">// Should be fine to use existing token..</span>
    translateClient.translate(params, <span class="function"><span class="keyword">function</span> <span class="params">(err, data)</span> {</span>
      translateCallback(data);
    });
  }
};

module.exports = {
  translate: translate,
  init: init
};
</code></pre>