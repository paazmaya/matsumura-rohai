<h1>yargs</h1>
<pre><code class="lang-js"><span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> minimist = require(<span class="string">'./lib/minimist'</span>);
<span class="keyword">var</span> wordwrap = require(<span class="string">'./lib/wordwrap'</span>);

<span class="comment">/*  Hack an instance of Argv with process.argv into Argv
    so people can do
        require('yargs')(['--beeble=1','-z','zizzle']).argv
    to parse a list of args and
        require('yargs').argv
    to get a parsed version of process.argv.
*/</span>

<span class="keyword">var</span> inst = Argv(process.argv.slice(<span class="number">2</span>));
Object.keys(inst).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
    Argv[key] = <span class="keyword">typeof</span> inst[key] == <span class="string">'function'</span>
        ? inst[key].bind(inst)
        : inst[key];
});

<span class="keyword">var</span> exports = module.exports = Argv;
<span class="function"><span class="keyword">function</span> <span class="title">Argv</span> <span class="params">(processArgs, cwd)</span> {</span>
    <span class="keyword">var</span> self = {};
    <span class="keyword">if</span> (!cwd) cwd = process.cwd();
    
    self.$<span class="number">0</span> = process.argv
        .slice(<span class="number">0</span>,<span class="number">2</span>)
        .map(<span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span>
            <span class="keyword">var</span> b = rebase(cwd, x);
            <span class="keyword">return</span> x.match(<span class="regexp">/^\//</span>) &amp;&amp; b.length &lt; x.length
                ? b : x
        })
        .join(<span class="string">' '</span>)
    ;
    
    <span class="keyword">if</span> (process.env._ != <span class="literal">undefined</span> &amp;&amp; process.argv[<span class="number">1</span>] == process.env._) {
        self.$<span class="number">0</span> = process.env._.replace(
            path.dirname(process.execPath) + <span class="string">'/'</span>, <span class="string">''</span>
        );
    }

    <span class="keyword">var</span> options;
    self.resetOptions = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        options = {
            boolean: [],
            string: [],
            alias: {},
            <span class="keyword">default</span>: [],
            requiresArg: [],
            count: [],
            normalize: [],
            config: []
        };
        <span class="keyword">return</span> self;
    };
    self.resetOptions();
    
    self.boolean = <span class="function"><span class="keyword">function</span> <span class="params">(bools)</span> {</span>
        options.boolean.push.apply(options.boolean, [].concat(bools));
        <span class="keyword">return</span> self;
    };

    self.normalize = <span class="function"><span class="keyword">function</span> <span class="params">(strings)</span> {</span>
        options.normalize.push.apply(options.normalize, [].concat(strings));
        <span class="keyword">return</span> self;
    };

    self.config = <span class="function"><span class="keyword">function</span> <span class="params">(configs)</span> {</span>
        options.config.push.apply(options.config, [].concat(configs));
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> examples = [];
    self.example = <span class="function"><span class="keyword">function</span> <span class="params">(cmd, description)</span> {</span>
        examples.push([cmd, description]);
        <span class="keyword">return</span> self;
    };
    
    self.string = <span class="function"><span class="keyword">function</span> <span class="params">(strings)</span> {</span>
        options.string.push.apply(options.string, [].concat(strings));
        <span class="keyword">return</span> self;
    };
    
    self.<span class="keyword">default</span> = <span class="function"><span class="keyword">function</span> <span class="params">(key, value)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'object'</span>) {
            Object.keys(key).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
                self.<span class="keyword">default</span>(k, key[k]);
            });
        }
        <span class="keyword">else</span> {
            options.<span class="keyword">default</span>[key] = value;
        }
        <span class="keyword">return</span> self;
    };
    
    self.alias = <span class="function"><span class="keyword">function</span> <span class="params">(x, y)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> x === <span class="string">'object'</span>) {
            Object.keys(x).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                self.alias(key, x[key]);
            });
        }
        <span class="keyword">else</span> {
            options.alias[x] = (options.alias[x] || []).concat(y);
        }
        <span class="keyword">return</span> self;
    };

    self.count = <span class="keyword">function</span>(counts) {
        options.count.push.apply(options.count, [].concat(counts));
        <span class="keyword">return</span> self;
    };
    
    <span class="keyword">var</span> demanded = {};
    self.demand = self.required = self.require = <span class="function"><span class="keyword">function</span> <span class="params">(keys, msg)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> keys == <span class="string">'number'</span>) {
            <span class="keyword">if</span> (!demanded._) demanded._ = { count: <span class="number">0</span>, msg: <span class="literal">null</span> };
            demanded._.count += keys;
            demanded._.msg = msg;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (Array.isArray(keys)) {
            keys.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                self.demand(key, msg);
            });
        }
        <span class="keyword">else</span> {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> msg === <span class="string">'string'</span>) {
                demanded[keys] = { msg: msg };
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (msg === <span class="literal">true</span> || <span class="keyword">typeof</span> msg === <span class="string">'undefined'</span>) {
                demanded[keys] = { msg: <span class="literal">null</span> };
            }
        }
        
        <span class="keyword">return</span> self;
    };

    self.requiresArg = <span class="function"><span class="keyword">function</span> <span class="params">(requiresArgs)</span> {</span>
        options.requiresArg.push.apply(options.requiresArg, [].concat(requiresArgs));
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> implied = {};
    self.implies = <span class="function"><span class="keyword">function</span> <span class="params">(key, value)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'object'</span>) {
            Object.keys(key).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
                self.implies(k, key[k]);
            });
        } <span class="keyword">else</span> {
            implied[key] = value;
        }
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> usage;
    self.usage = <span class="function"><span class="keyword">function</span> <span class="params">(msg, opts)</span> {</span>
        <span class="keyword">if</span> (!opts &amp;&amp; <span class="keyword">typeof</span> msg === <span class="string">'object'</span>) {
            opts = msg;
            msg = <span class="literal">null</span>;
        }
        
        usage = msg;
        
        <span class="keyword">if</span> (opts) self.options(opts);
        
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> fails = [];
    self.fail = <span class="function"><span class="keyword">function</span> <span class="params">(f)</span> {</span>
        fails.push(f);
        <span class="keyword">return</span> self;
    };

    <span class="function"><span class="keyword">function</span> <span class="title">fail</span> <span class="params">(msg)</span> {</span>
        <span class="keyword">if</span> (fails.length) {
            fails.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(f)</span> {</span>
                f(msg);
            });
        } <span class="keyword">else</span> {
            <span class="keyword">if</span> (showHelpOnFail) {
                self.showHelp();
            }
            <span class="keyword">if</span> (msg) console.error(msg);
            <span class="keyword">if</span> (failMessage) {
                <span class="keyword">if</span> (msg) {
                    console.error(<span class="string">""</span>);
                }
                console.error(failMessage);
            }
            process.exit(<span class="number">1</span>);
        }
    }
    
    <span class="keyword">var</span> checks = [];
    self.check = <span class="function"><span class="keyword">function</span> <span class="params">(f)</span> {</span>
        checks.push(f);
        <span class="keyword">return</span> self;
    };

    self.defaults = self.<span class="keyword">default</span>;

    <span class="keyword">var</span> descriptions = {};
    self.describe = <span class="function"><span class="keyword">function</span> <span class="params">(key, desc)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'object'</span>) {
            Object.keys(key).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
                self.describe(k, key[k]);
            });
        }
        <span class="keyword">else</span> {
            descriptions[key] = desc;
        }
        <span class="keyword">return</span> self;
    };
    
    self.parse = <span class="function"><span class="keyword">function</span> <span class="params">(args)</span> {</span>
        <span class="keyword">return</span> parseArgs(args);
    };
    
    self.option = self.options = <span class="function"><span class="keyword">function</span> <span class="params">(key, opt)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'object'</span>) {
            Object.keys(key).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(k)</span> {</span>
                self.options(k, key[k]);
            });
        }
        <span class="keyword">else</span> {
            <span class="keyword">if</span> (opt.alias) self.alias(key, opt.alias);

            <span class="keyword">var</span> demand = opt.demand || opt.required || opt.require;
            <span class="keyword">if</span> (demand) {
                self.demand(key, demand);
            }

            <span class="keyword">if</span> (<span class="keyword">typeof</span> opt.<span class="keyword">default</span> !== <span class="string">'undefined'</span>) {
                self.<span class="keyword">default</span>(key, opt.<span class="keyword">default</span>);
            }
            
            <span class="keyword">if</span> (opt.boolean || opt.type === <span class="string">'boolean'</span>) {
                self.boolean(key);
                <span class="keyword">if</span> (opt.alias) self.boolean(opt.alias);
            }
            <span class="keyword">if</span> (opt.string || opt.type === <span class="string">'string'</span>) {
                self.string(key);
                <span class="keyword">if</span> (opt.alias) self.string(opt.alias);
            }
            <span class="keyword">if</span> (opt.count || opt.type === <span class="string">'count'</span>) {
                self.count(key);
            }

            <span class="keyword">var</span> desc = opt.describe || opt.description || opt.desc;
            <span class="keyword">if</span> (desc) {
                self.describe(key, desc);
            }

            <span class="keyword">if</span> (opt.requiresArg) {
                self.requiresArg(key);
            }
        }

        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> wrap = <span class="literal">null</span>;
    self.wrap = <span class="function"><span class="keyword">function</span> <span class="params">(cols)</span> {</span>
        wrap = cols;
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> strict = <span class="literal">false</span>;
    self.strict = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        strict = <span class="literal">true</span>;
        <span class="keyword">return</span> self;
    };
    
    self.showHelp = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
        <span class="keyword">if</span> (!fn) fn = console.error.bind(console);
        fn(self.help());
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> version = <span class="literal">null</span>;
    <span class="keyword">var</span> versionOpt = <span class="literal">null</span>;
    self.version = <span class="function"><span class="keyword">function</span> <span class="params">(ver, opt, msg)</span> {</span>
        version = ver;
        versionOpt = opt;
        self.describe(opt, msg || <span class="string">'Show version number'</span>);
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> helpOpt = <span class="literal">null</span>;
    self.addHelpOpt = <span class="function"><span class="keyword">function</span> <span class="params">(opt, msg)</span> {</span>
        helpOpt = opt;
        self.describe(opt, msg || <span class="string">'Show help'</span>);
        <span class="keyword">return</span> self;
    };

    <span class="keyword">var</span> failMessage = <span class="literal">null</span>;
    <span class="keyword">var</span> showHelpOnFail = <span class="literal">true</span>;
    self.showHelpOnFail = <span class="function"><span class="keyword">function</span> <span class="params">(enabled, message)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> enabled === <span class="string">'string'</span>) {
            enabled = <span class="literal">true</span>;
            message = enabled;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> enabled === <span class="string">'undefined'</span>) {
            enabled = <span class="literal">true</span>;
        }
        failMessage = message;
        showHelpOnFail = enabled;
        <span class="keyword">return</span> self;
    };


    self.help = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (arguments.length > <span class="number">0</span>) {
            <span class="keyword">return</span> self.addHelpOpt.apply(self, arguments);
        }

        <span class="keyword">var</span> keys = Object.keys(
            Object.keys(descriptions)
            .concat(Object.keys(demanded))
            .concat(Object.keys(options.<span class="keyword">default</span>))
            .reduce(<span class="function"><span class="keyword">function</span> <span class="params">(acc, key)</span> {</span>
                <span class="keyword">if</span> (key !== <span class="string">'_'</span>) acc[key] = <span class="literal">true</span>;
                <span class="keyword">return</span> acc;
            }, {})
        );
        
        <span class="keyword">var</span> help = keys.length ? [ <span class="string">'Options:'</span> ] : [];

        <span class="keyword">if</span> (examples.length) {
            help.unshift(<span class="string">''</span>);
            examples.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(example)</span> {</span>
                example[<span class="number">0</span>] = example[<span class="number">0</span>].replace(<span class="regexp">/\$0/g</span>, self.$<span class="number">0</span>);
            });

            <span class="keyword">var</span> commandlen = longest(examples.map(<span class="function"><span class="keyword">function</span> <span class="params">(a)</span> {</span>
                <span class="keyword">return</span> a[<span class="number">0</span>];
            }));

            <span class="keyword">var</span> exampleLines = examples.map(<span class="keyword">function</span>(example) {
                <span class="keyword">var</span> command = example[<span class="number">0</span>];
                <span class="keyword">var</span> description = example[<span class="number">1</span>];
                command += Array(commandlen + <span class="number">5</span> - command.length).join(<span class="string">' '</span>);
                <span class="keyword">return</span> <span class="string">'  '</span> + command + description;
            });

            exampleLines.push(<span class="string">''</span>);
            help = exampleLines.concat(help);
            help.unshift(<span class="string">'Examples:'</span>);
        }

        <span class="keyword">if</span> (usage) {
            help.unshift(usage.replace(<span class="regexp">/\$0/g</span>, self.$<span class="number">0</span>), <span class="string">''</span>);
        }

        <span class="keyword">var</span> aliasKeys = (Object.keys(options.alias) || [])
            .concat(Object.keys(self.parsed.newAliases) || []);

        keys = keys.filter(<span class="keyword">function</span>(key) {
            <span class="keyword">return</span> !self.parsed.newAliases[key] &amp;&amp; aliasKeys.every(<span class="keyword">function</span>(alias) {
                <span class="keyword">return</span> -<span class="number">1</span> == (options.alias[alias] || []).indexOf(key);
            });
        });
        <span class="keyword">var</span> switches = keys.reduce(<span class="function"><span class="keyword">function</span> <span class="params">(acc, key)</span> {</span>
            acc[key] = [ key ].concat(options.alias[key] || [])
                .map(<span class="function"><span class="keyword">function</span> <span class="params">(sw)</span> {</span>
                    <span class="keyword">return</span> (sw.length > <span class="number">1</span> ? <span class="string">'--'</span> : <span class="string">'-'</span>) + sw
                })
                .join(<span class="string">', '</span>)
            ;
            <span class="keyword">return</span> acc;
        }, {});

        <span class="keyword">var</span> switchlen = longest(Object.keys(switches).map(<span class="function"><span class="keyword">function</span> <span class="params">(s)</span> {</span>
            <span class="keyword">return</span> switches[s] || <span class="string">''</span>;
        }));
        
        <span class="keyword">var</span> desclen = longest(Object.keys(descriptions).map(<span class="function"><span class="keyword">function</span> <span class="params">(d)</span> {</span> 
            <span class="keyword">return</span> descriptions[d] || <span class="string">''</span>;
        }));
        
        keys.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
            <span class="keyword">var</span> kswitch = switches[key];
            <span class="keyword">var</span> desc = descriptions[key] || <span class="string">''</span>;
            
            <span class="keyword">if</span> (wrap) {
                desc = wordwrap(switchlen + <span class="number">4</span>, wrap)(desc)
                    .slice(switchlen + <span class="number">4</span>)
                ;
            }
            
            <span class="keyword">var</span> spadding = <span class="keyword">new</span> Array(
                Math.max(switchlen - kswitch.length + <span class="number">3</span>, <span class="number">0</span>)
            ).join(<span class="string">' '</span>);
            
            <span class="keyword">var</span> dpadding = <span class="keyword">new</span> Array(
                Math.max(desclen - desc.length + <span class="number">1</span>, <span class="number">0</span>)
            ).join(<span class="string">' '</span>);
            
            <span class="keyword">var</span> type = <span class="literal">null</span>;
            
            <span class="keyword">if</span> (options.boolean[key]) type = <span class="string">'[boolean]'</span>;
            <span class="keyword">if</span> (options.count[key]) type = <span class="string">'[count]'</span>;
            <span class="keyword">if</span> (options.string[key]) type = <span class="string">'[string]'</span>;
            <span class="keyword">if</span> (options.normalize[key]) type = <span class="string">'[string]'</span>;
            
            <span class="keyword">if</span> (!wrap &amp;&amp; dpadding.length > <span class="number">0</span>) {
                desc += dpadding;
            }
            
            <span class="keyword">var</span> prelude = <span class="string">'  '</span> + kswitch + spadding;
            <span class="keyword">var</span> extra = [
                type,
                demanded[key]
                    ? <span class="string">'[required]'</span>
                    : <span class="literal">null</span>
                ,
                options.<span class="keyword">default</span>[key] !== <span class="literal">undefined</span>
                    ? <span class="string">'[default: '</span> + (<span class="keyword">typeof</span> options.<span class="keyword">default</span>[key] === <span class="string">'string'</span> ?
                    JSON.stringify : String)(options.<span class="keyword">default</span>[key]) + <span class="string">']'</span>
                    : <span class="literal">null</span>
            ].filter(Boolean).join(<span class="string">'  '</span>);
            
            <span class="keyword">var</span> body = [ desc, extra ].filter(Boolean).join(<span class="string">'  '</span>);
            
            <span class="keyword">if</span> (wrap) {
                <span class="keyword">var</span> dlines = desc.split(<span class="string">'\n'</span>);
                <span class="keyword">var</span> dlen = dlines.slice(-<span class="number">1</span>)[<span class="number">0</span>].length
                    + (dlines.length === <span class="number">1</span> ? prelude.length : <span class="number">0</span>)
                
                body = desc + (dlen + extra.length > wrap - <span class="number">2</span>
                    ? <span class="string">'\n'</span>
                        + <span class="keyword">new</span> Array(wrap - extra.length + <span class="number">1</span>).join(<span class="string">' '</span>)
                        + extra
                    : <span class="keyword">new</span> Array(wrap - extra.length - dlen + <span class="number">1</span>).join(<span class="string">' '</span>)
                        + extra
                );
            }
            
            help.push(prelude + body);
        });
        
        <span class="keyword">if</span> (keys.length) help.push(<span class="string">''</span>);
        <span class="keyword">return</span> help.join(<span class="string">'\n'</span>);
    };
    
    Object.defineProperty(self, <span class="string">'argv'</span>, {
        get : <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> <span class="keyword">return</span> parseArgs(processArgs) },
        enumerable : <span class="literal">true</span>
    });
    
    <span class="function"><span class="keyword">function</span> <span class="title">parseArgs</span> <span class="params">(args)</span> {</span>
        <span class="keyword">var</span> parsed = minimist(args, options),
            argv = parsed.argv,
            aliases = parsed.aliases;

        argv.$<span class="number">0</span> = self.$<span class="number">0</span>;

        self.parsed = parsed;

        Object.keys(argv).forEach(<span class="keyword">function</span>(key) {
            <span class="keyword">if</span> (key === helpOpt) {
                self.showHelp(console.log);
                process.exit(<span class="number">0</span>);
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (key === versionOpt) {
                process.stdout.write(version);
                process.exit(<span class="number">0</span>);
            }
        });

        <span class="keyword">if</span> (demanded._ &amp;&amp; argv._.length &lt; demanded._.count) {
            <span class="keyword">if</span> (demanded._.msg) {
                fail(demanded._.msg);
            } <span class="keyword">else</span> {
                fail(<span class="string">'Not enough non-option arguments: got '</span>
                    + argv._.length + <span class="string">', need at least '</span> + demanded._.count
                );
            }
        }

        <span class="keyword">if</span> (options.requiresArg.length > <span class="number">0</span>) {
            <span class="keyword">var</span> missingRequiredArgs = [];

            options.requiresArg.forEach(<span class="keyword">function</span>(key) {
                <span class="keyword">var</span> value = argv[key];

                <span class="comment">// minimist sets --foo value to true / --no-foo to false</span>
                <span class="keyword">if</span> (value === <span class="literal">true</span> || value === <span class="literal">false</span>) {
                    missingRequiredArgs.push(key);
                }
            });

            <span class="keyword">if</span> (missingRequiredArgs.length == <span class="number">1</span>) {
                fail(<span class="string">"Missing argument value: "</span> + missingRequiredArgs[<span class="number">0</span>]);
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (missingRequiredArgs.length > <span class="number">1</span>) {
                message = <span class="string">"Missing argument values: "</span> + missingRequiredArgs.join(<span class="string">", "</span>);
                fail(message);
            }
        }
        
        <span class="keyword">var</span> missing = <span class="literal">null</span>;
        Object.keys(demanded).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
            <span class="keyword">if</span> (!argv.hasOwnProperty(key)) {
                missing = missing || {};
                missing[key] = demanded[key];
            }
        });
        
        <span class="keyword">if</span> (missing) {
            <span class="keyword">var</span> customMsgs = [];
            Object.keys(missing).forEach(<span class="keyword">function</span>(key) {
                <span class="keyword">var</span> msg = missing[key].msg;
                <span class="keyword">if</span> (msg &amp;&amp; customMsgs.indexOf(msg) &lt; <span class="number">0</span>) {
                    customMsgs.push(msg);
                }
            });
            <span class="keyword">var</span> customMsg = customMsgs.length ? <span class="string">'\n'</span> + customMsgs.join(<span class="string">'\n'</span>) : <span class="string">''</span>;

            fail(<span class="string">'Missing required arguments: '</span> + Object.keys(missing).join(<span class="string">', '</span>) + customMsg);
        }

        <span class="keyword">if</span> (strict) {
            <span class="keyword">var</span> unknown = [];

            <span class="keyword">var</span> aliases = {};

            Object.keys(parsed.aliases).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                parsed.aliases[key].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(alias)</span> {</span>
                    aliases[alias] = key;
                });
            });

            Object.keys(argv).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                <span class="keyword">if</span> (key !== <span class="string">"$0"</span> &amp;&amp; key !== <span class="string">"_"</span> &amp;&amp;
                    !descriptions.hasOwnProperty(key) &amp;&amp;
                    !demanded.hasOwnProperty(key) &amp;&amp;
                    !aliases.hasOwnProperty(key)) {
                    unknown.push(key);
                }
            });

            <span class="keyword">if</span> (unknown.length == <span class="number">1</span>) {
                fail(<span class="string">"Unknown argument: "</span> + unknown[<span class="number">0</span>]);
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (unknown.length > <span class="number">1</span>) {
                fail(<span class="string">"Unknown arguments: "</span> + unknown.join(<span class="string">", "</span>));
            }
        }

        checks.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(f)</span> {</span>
            <span class="keyword">try</span> {
                <span class="keyword">var</span> result = f(argv, aliases);
                <span class="keyword">if</span> (result === <span class="literal">false</span>) {
                    fail(<span class="string">'Argument check failed: '</span> + f.toString());
                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">'string'</span>) {
                    fail(result);
                }
            }
            <span class="keyword">catch</span> (err) {
                fail(err)
            }
        });

        <span class="keyword">var</span> implyFail = [];
        Object.keys(implied).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
            <span class="keyword">var</span> num, origKey = key, value = implied[key];

            <span class="comment">// convert string '1' to number 1</span>
            <span class="keyword">var</span> num = Number(key);
            key = isNaN(num) ? key : num;

            <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'number'</span>) {
                <span class="comment">// check length of argv._</span>
                key = argv._.length >= key;
            } <span class="keyword">else</span> <span class="keyword">if</span> (key.match(<span class="regexp">/^--no-.+/</span>)) {
                <span class="comment">// check if key doesn't exist</span>
                key = key.match(<span class="regexp">/^--no-(.+)/</span>)[<span class="number">1</span>];
                key = !argv[key];
            } <span class="keyword">else</span> {
                <span class="comment">// check if key exists</span>
                key = argv[key];
            }

            num = Number(value);
            value = isNaN(num) ? value : num;

            <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'number'</span>) {
                value = argv._.length >= value;
            } <span class="keyword">else</span> <span class="keyword">if</span> (value.match(<span class="regexp">/^--no-.+/</span>)) {
                value = value.match(<span class="regexp">/^--no-(.+)/</span>)[<span class="number">1</span>];
                value = !argv[value];
            } <span class="keyword">else</span> {
                value = argv[value];
            }

            <span class="keyword">if</span> (key &amp;&amp; !value) {
                implyFail.push(origKey);
            }
        });

        <span class="keyword">if</span> (implyFail.length) {
            <span class="keyword">var</span> msg = <span class="string">'Implications failed:\n'</span>;

            implyFail.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                msg += (<span class="string">'  '</span> + key + <span class="string">' -> '</span> + implied[key] + <span class="string">'\n'</span>);
            });

            fail(msg);
        }
        
        <span class="keyword">return</span> argv;
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">longest</span> <span class="params">(xs)</span> {</span>
        <span class="keyword">return</span> Math.max.apply(
            <span class="literal">null</span>,
            xs.map(<span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span> <span class="keyword">return</span> x.length })
        );
    }
    
    <span class="keyword">return</span> self;
};

<span class="comment">// rebase an absolute path to a relative one with respect to a base directory</span>
<span class="comment">// exported for tests</span>
exports.rebase = rebase;
<span class="function"><span class="keyword">function</span> <span class="title">rebase</span> <span class="params">(base, dir)</span> {</span>
    <span class="keyword">var</span> ds = path.normalize(dir).split(<span class="string">'/'</span>).slice(<span class="number">1</span>);
    <span class="keyword">var</span> bs = path.normalize(base).split(<span class="string">'/'</span>).slice(<span class="number">1</span>);
    
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; ds[i] &amp;&amp; ds[i] == bs[i]; i++);
    ds.splice(<span class="number">0</span>, i); bs.splice(<span class="number">0</span>, i);
    
    <span class="keyword">var</span> p = path.normalize(
        bs.map(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> <span class="keyword">return</span> <span class="string">'..'</span> }).concat(ds).join(<span class="string">'/'</span>)
    ).replace(<span class="regexp">/\/$/</span>,<span class="string">''</span>).replace(<span class="regexp">/^$/</span>, <span class="string">'.'</span>);
    <span class="keyword">return</span> p.match(<span class="regexp">/^[.\/]/</span>) ? p : <span class="string">'./'</span> + p;
};
</code></pre>