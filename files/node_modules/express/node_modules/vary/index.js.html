<h1>vary</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * vary
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module exports.
 */</span>

module.exports = vary;
module.exports.append = append;

<span class="comment">/**
 * Variables.
 */</span>

<span class="keyword">var</span> separators = <span class="regexp">/[\(\)&lt;>@,;:\\"\/\[\]\?=\{\}\u0020\u0009]/</span>;

<span class="comment">/**
 * Append a field to a vary header.
 *
 * @param {String} header
 * @param {String|Array} field
 * @return {String}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">(header, field)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> header !== <span class="string">'string'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'header argument is required'</span>);
  }

  <span class="keyword">if</span> (!field) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'field argument is required'</span>);
  }

  <span class="comment">// get fields array</span>
  <span class="keyword">var</span> fields = !Array.isArray(field)
    ? parse(String(field))
    : field;

  <span class="comment">// assert on invalid fields</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; fields.length; i++) {
    <span class="keyword">if</span> (separators.test(fields[i])) {
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'field argument contains an invalid header'</span>);
    }
  }

  <span class="comment">// existing, unspecified vary</span>
  <span class="keyword">if</span> (header === <span class="string">'*'</span>) {
    <span class="keyword">return</span> header;
  }

  <span class="comment">// enumerate current values</span>
  <span class="keyword">var</span> vals = parse(header.toLowerCase());

  <span class="comment">// unspecified vary</span>
  <span class="keyword">if</span> (fields.indexOf(<span class="string">'*'</span>) !== -<span class="number">1</span> || vals.indexOf(<span class="string">'*'</span>) !== -<span class="number">1</span>) {
    <span class="keyword">return</span> <span class="string">'*'</span>;
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; fields.length; i++) {
    field = fields[i].toLowerCase();

    <span class="comment">// append value (case-preserving)</span>
    <span class="keyword">if</span> (vals.indexOf(field) === -<span class="number">1</span>) {
      vals.push(field);
      header = header
        ? header + <span class="string">', '</span> + fields[i]
        : fields[i];
    }
  }

  <span class="keyword">return</span> header;
}

<span class="comment">/**
 * Parse a vary header into an array.
 *
 * @param {String} header
 * @return {Array}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">(header)</span> {</span>
  <span class="keyword">return</span> header.trim().split(<span class="regexp">/ *, */</span>);
}

<span class="comment">/**
 * Mark that a request is varied on a header field.
 *
 * @param {Object} res
 * @param {String|Array} field
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">vary</span><span class="params">(res, field)</span> {</span>
  <span class="keyword">if</span> (!res || !res.getHeader || !res.setHeader) {
    <span class="comment">// quack quack</span>
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'res argument is required'</span>);
  }

  <span class="comment">// get existing header</span>
  <span class="keyword">var</span> val = res.getHeader(<span class="string">'Vary'</span>) || <span class="string">''</span>
  <span class="keyword">var</span> header = Array.isArray(val)
    ? val.join(<span class="string">', '</span>)
    : String(val);

  <span class="comment">// set new header</span>
  res.setHeader(<span class="string">'Vary'</span>, append(header, field));
}
</code></pre>