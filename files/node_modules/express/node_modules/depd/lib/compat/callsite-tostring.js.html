<h1>callsite-tostring.js</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * depd
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module exports.
 */</span>

module.exports = callSiteToString

<span class="comment">/**
 * Format a CallSite file location to a string.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">callSiteFileLocation</span><span class="params">(callSite)</span> {</span>
  <span class="keyword">var</span> fileName
  <span class="keyword">var</span> fileLocation = <span class="string">''</span>

  <span class="keyword">if</span> (callSite.isNative()) {
    fileLocation = <span class="string">'native'</span>
  } <span class="keyword">else</span> <span class="keyword">if</span> (callSite.isEval()) {
    fileName = callSite.getScriptNameOrSourceURL()
    <span class="keyword">if</span> (!fileName) {
      fileLocation = callSite.getEvalOrigin()
    }
  } <span class="keyword">else</span> {
    fileName = callSite.getFileName()
  }

  <span class="keyword">if</span> (fileName) {
    fileLocation += fileName

    <span class="keyword">var</span> lineNumber = callSite.getLineNumber()
    <span class="keyword">if</span> (lineNumber != <span class="literal">null</span>) {
      fileLocation += <span class="string">':'</span> + lineNumber

      <span class="keyword">var</span> columnNumber = callSite.getColumnNumber()
      <span class="keyword">if</span> (columnNumber) {
        fileLocation += <span class="string">':'</span> + columnNumber
      }
    }
  }

  <span class="keyword">return</span> fileLocation || <span class="string">'unknown source'</span>
}

<span class="comment">/**
 * Format a CallSite to a string.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">callSiteToString</span><span class="params">(callSite)</span> {</span>
  <span class="keyword">var</span> addSuffix = <span class="literal">true</span>
  <span class="keyword">var</span> fileLocation = callSiteFileLocation(callSite)
  <span class="keyword">var</span> functionName = callSite.getFunctionName()
  <span class="keyword">var</span> isConstructor = callSite.isConstructor()
  <span class="keyword">var</span> isMethodCall = !(callSite.isToplevel() || isConstructor)
  <span class="keyword">var</span> line = <span class="string">''</span>

  <span class="keyword">if</span> (isMethodCall) {
    <span class="keyword">var</span> methodName = callSite.getMethodName()
    <span class="keyword">var</span> typeName = getConstructorName(callSite)

    <span class="keyword">if</span> (functionName) {
      <span class="keyword">if</span> (typeName &amp;&amp; functionName.indexOf(typeName) !== <span class="number">0</span>) {
        line += typeName + <span class="string">'.'</span>
      }

      line += functionName

      <span class="keyword">if</span> (methodName &amp;&amp; functionName.lastIndexOf(<span class="string">'.'</span> + methodName) !== functionName.length - methodName.length - <span class="number">1</span>) {
        line += <span class="string">' [as '</span> + methodName + <span class="string">']'</span>
      }
    } <span class="keyword">else</span> {
      line += typeName + <span class="string">'.'</span> + (methodName || <span class="string">'&lt;anonymous>'</span>)
    }
  } <span class="keyword">else</span> <span class="keyword">if</span> (isConstructor) {
    line += <span class="string">'new '</span> + (functionName || <span class="string">'&lt;anonymous>'</span>)
  } <span class="keyword">else</span> <span class="keyword">if</span> (functionName) {
    line += functionName
  } <span class="keyword">else</span> {
    addSuffix = <span class="literal">false</span>
    line += fileLocation
  }

  <span class="keyword">if</span> (addSuffix) {
    line += <span class="string">' ('</span> + fileLocation + <span class="string">')'</span>
  }

  <span class="keyword">return</span> line
}

<span class="comment">/**
 * Get constructor name of reviver.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">getConstructorName</span><span class="params">(obj)</span> {</span>
  <span class="keyword">var</span> receiver = obj.receiver
  <span class="keyword">return</span> (receiver.constructor &amp;&amp; receiver.constructor.name) || <span class="literal">null</span>
}
</code></pre>