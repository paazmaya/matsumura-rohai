<h1>ee-first</h1>
<pre><code class="lang-js">module.exports = <span class="function"><span class="keyword">function</span> <span class="title">first</span><span class="params">(stuff, done)</span> {</span>
  <span class="keyword">if</span> (!Array.isArray(stuff))
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'arg must be an array of [ee, events...] arrays'</span>)

  <span class="keyword">var</span> cleanups = []

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stuff.length; i++) {
    <span class="keyword">var</span> arr = stuff[i]

    <span class="keyword">if</span> (!Array.isArray(arr) || arr.length &lt; <span class="number">2</span>)
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'each array member must be [ee, events...]'</span>)

    <span class="keyword">var</span> ee = arr[<span class="number">0</span>]

    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">1</span>; j &lt; arr.length; j++) {
      <span class="keyword">var</span> event = arr[j]
      <span class="keyword">var</span> fn = listener(event, cleanup)

      <span class="comment">// listen to the event</span>
      ee.on(event, fn)
      <span class="comment">// push this listener to the list of cleanups</span>
      cleanups.push({
        ee: ee,
        event: event,
        fn: fn,
      })
    }
  }

  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
    done = fn
  }

  <span class="function"><span class="keyword">function</span> <span class="title">cleanup</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> x
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cleanups.length; i++) {
      x = cleanups[i]
      x.ee.removeListener(x.event, x.fn)
    }
    done.apply(<span class="literal">null</span>, arguments)
  }
}

<span class="function"><span class="keyword">function</span> <span class="title">listener</span><span class="params">(event, done)</span> {</span>
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">onevent</span><span class="params">(arg1)</span> {</span>
    <span class="keyword">var</span> args = <span class="keyword">new</span> Array(arguments.length)
    <span class="keyword">var</span> ee = <span class="keyword">this</span>
    <span class="keyword">var</span> err = event === <span class="string">'error'</span>
      ? arg1
      : <span class="literal">null</span>

    <span class="comment">// copy args to prevent arguments escaping scope</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; args.length; i++) {
      args[i] = arguments[i]
    }

    done(err, ee, event, args)
  }
}
</code></pre>