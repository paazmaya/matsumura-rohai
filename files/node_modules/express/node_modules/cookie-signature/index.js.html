<h1>cookie-signature</h1>
<pre><code class="lang-js"><span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> crypto = require(<span class="string">'crypto'</span>);

<span class="comment">/**
 * Sign the given `val` with `secret`.
 *
 * @param {String} val
 * @param {String} secret
 * @return {String}
 * @api private
 */</span>

exports.sign = <span class="keyword">function</span>(val, secret){
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> val) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'cookie required'</span>);
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> secret) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'secret required'</span>);
  <span class="keyword">return</span> val + <span class="string">'.'</span> + crypto
    .createHmac(<span class="string">'sha256'</span>, secret)
    .update(val)
    .digest(<span class="string">'base64'</span>)
    .replace(<span class="regexp">/\=+$/</span>, <span class="string">''</span>);
};

<span class="comment">/**
 * Unsign and decode the given `val` with `secret`,
 * returning `false` if the signature is invalid.
 *
 * @param {String} val
 * @param {String} secret
 * @return {String|Boolean}
 * @api private
 */</span>

exports.unsign = <span class="keyword">function</span>(val, secret){
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> val) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'cookie required'</span>);
  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> secret) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'secret required'</span>);
  <span class="keyword">var</span> str = val.slice(<span class="number">0</span>, val.lastIndexOf(<span class="string">'.'</span>))
    , mac = exports.sign(str, secret);
  
  <span class="keyword">return</span> sha1(mac) == sha1(val) ? str : <span class="literal">false</span>;
};

<span class="comment">/**
 * Private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">sha1</span><span class="params">(str)</span>{</span>
  <span class="keyword">return</span> crypto.createHash(<span class="string">'sha1'</span>).update(str).digest(<span class="string">'hex'</span>);
}
</code></pre>