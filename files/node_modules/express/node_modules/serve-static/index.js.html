<h1>serve-static</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * serve-static
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> escapeHtml = require(<span class="string">'escape-html'</span>);
<span class="keyword">var</span> merge = require(<span class="string">'utils-merge'</span>);
<span class="keyword">var</span> parseurl = require(<span class="string">'parseurl'</span>);
<span class="keyword">var</span> resolve = require(<span class="string">'path'</span>).resolve;
<span class="keyword">var</span> send = require(<span class="string">'send'</span>);
<span class="keyword">var</span> url = require(<span class="string">'url'</span>);

<span class="comment">/**
 * @param {String} root
 * @param {Object} options
 * @return {Function}
 * @api public
 */</span>

exports = module.exports = <span class="function"><span class="keyword">function</span> <span class="title">serveStatic</span><span class="params">(root, options)</span> {</span>
  <span class="keyword">if</span> (!root) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'root path required'</span>)
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> root !== <span class="string">'string'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'root path must be a string'</span>)
  }

  <span class="comment">// copy options object</span>
  options = merge({}, options)

  <span class="comment">// resolve root to absolute</span>
  root = resolve(root)

  <span class="comment">// default redirect</span>
  <span class="keyword">var</span> redirect = options.redirect !== <span class="literal">false</span>

  <span class="comment">// headers listener</span>
  <span class="keyword">var</span> setHeaders = options.setHeaders
  <span class="keyword">delete</span> options.setHeaders

  <span class="keyword">if</span> (setHeaders &amp;&amp; <span class="keyword">typeof</span> setHeaders !== <span class="string">'function'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'option setHeaders must be function'</span>)
  }

  <span class="comment">// setup options for send</span>
  options.maxage = options.maxage || options.maxAge || <span class="number">0</span>
  options.root = root

  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">serveStatic</span><span class="params">(req, res, next)</span> {</span>
    <span class="keyword">if</span> (req.method !== <span class="string">'GET'</span> &amp;&amp; req.method !== <span class="string">'HEAD'</span>) {
      <span class="keyword">return</span> next()
    }

    <span class="keyword">var</span> opts = merge({}, options)
    <span class="keyword">var</span> originalUrl = parseurl.original(req)
    <span class="keyword">var</span> path = parseurl(req).pathname
    <span class="keyword">var</span> hasTrailingSlash = originalUrl.pathname[originalUrl.pathname.length - <span class="number">1</span>] === <span class="string">'/'</span>

    <span class="keyword">if</span> (path === <span class="string">'/'</span> &amp;&amp; !hasTrailingSlash) {
      <span class="comment">// make sure redirect occurs at mount</span>
      path = <span class="string">''</span>
    }

    <span class="comment">// create send stream</span>
    <span class="keyword">var</span> stream = send(req, path, opts)

    <span class="keyword">if</span> (redirect) {
      <span class="comment">// redirect relative to originalUrl</span>
      stream.on(<span class="string">'directory'</span>, <span class="function"><span class="keyword">function</span> <span class="title">redirect</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (hasTrailingSlash) {
          <span class="keyword">return</span> next()
        }

        originalUrl.pathname += <span class="string">'/'</span>

        <span class="keyword">var</span> target = url.format(originalUrl)

        res.statusCode = <span class="number">303</span>
        res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html; charset=utf-8'</span>)
        res.setHeader(<span class="string">'Location'</span>, target)
        res.end(<span class="string">'Redirecting to &lt;a href="'</span> + escapeHtml(target) + <span class="string">'">'</span> + escapeHtml(target) + <span class="string">'&lt;/a>\n'</span>)
      })
    } <span class="keyword">else</span> {
      <span class="comment">// forward to next middleware on directory</span>
      stream.on(<span class="string">'directory'</span>, next)
    }

    <span class="comment">// add headers listener</span>
    <span class="keyword">if</span> (setHeaders) {
      stream.on(<span class="string">'headers'</span>, setHeaders)
    }

    <span class="comment">// forward non-404 errors</span>
    stream.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">(err)</span> {</span>
      next(err.status === <span class="number">404</span> ? <span class="literal">null</span> : err)
    })

    <span class="comment">// pipe</span>
    stream.pipe(res)
  }
}

<span class="comment">/**
 * Expose mime module.
 *
 * If you wish to extend the mime table use this
 * reference to the "mime" module in the npm registry.
 */</span>

exports.mime = send.mime
</code></pre>