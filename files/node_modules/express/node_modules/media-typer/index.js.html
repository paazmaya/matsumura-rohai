<h1>media-typer</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * media-typer
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * RegExp to match *( ";" parameter ) in RFC 2616 sec 3.7
 *
 * parameter     = token "=" ( token | quoted-string )
 * token         = 1*&lt;any CHAR except CTLs or separators>
 * separators    = "(" | ")" | "&lt;" | ">" | "@"
 *               | "," | ";" | ":" | "\" | &lt;">
 *               | "/" | "[" | "]" | "?" | "="
 *               | "{" | "}" | SP | HT
 * quoted-string = ( &lt;"> *(qdtext | quoted-pair ) &lt;"> )
 * qdtext        = &lt;any TEXT except &lt;">>
 * quoted-pair   = "\" CHAR
 * CHAR          = &lt;any US-ASCII character (octets 0 - 127)>
 * TEXT          = &lt;any OCTET except CTLs, but including LWS>
 * LWS           = [CRLF] 1*( SP | HT )
 * CRLF          = CR LF
 * CR            = &lt;US-ASCII CR, carriage return (13)>
 * LF            = &lt;US-ASCII LF, linefeed (10)>
 * SP            = &lt;US-ASCII SP, space (32)>
 * SHT           = &lt;US-ASCII HT, horizontal-tab (9)>
 * CTL           = &lt;any US-ASCII control character (octets 0 - 31) and DEL (127)>
 * OCTET         = &lt;any 8-bit sequence of data>
 */</span>
<span class="keyword">var</span> paramRegExp = <span class="regexp">/; *([!#$%&amp;'\*\+\-\.0-9A-Z\^_`a-z\|~]+) *= *("(?:[ !\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u0020-\u007e])*"|[!#$%&amp;'\*\+\-\.0-9A-Z\^_`a-z\|~]+) */g</span>;
<span class="keyword">var</span> textRegExp = <span class="regexp">/^[\u0020-\u007e\u0080-\u00ff]+$/</span>
<span class="keyword">var</span> tokenRegExp = <span class="regexp">/^[!#$%&amp;'\*\+\-\.0-9A-Z\^_`a-z\|~]+$/</span>

<span class="comment">/**
 * RegExp to match quoted-pair in RFC 2616
 *
 * quoted-pair = "\" CHAR
 * CHAR        = &lt;any US-ASCII character (octets 0 - 127)>
 */</span>
<span class="keyword">var</span> qescRegExp = <span class="regexp">/\\([\u0000-\u007f])/g</span>;

<span class="comment">/**
 * RegExp to match chars that must be quoted-pair in RFC 2616
 */</span>
<span class="keyword">var</span> quoteRegExp = <span class="regexp">/([\\"])/g</span>;

<span class="comment">/**
 * RegExp to match type in RFC 6838
 *
 * type-name = restricted-name
 * subtype-name = restricted-name
 * restricted-name = restricted-name-first *126restricted-name-chars
 * restricted-name-first  = ALPHA / DIGIT
 * restricted-name-chars  = ALPHA / DIGIT / "!" / "#" /
 *                          "$" / "&amp;" / "-" / "^" / "_"
 * restricted-name-chars =/ "." ; Characters before first dot always
 *                              ; specify a facet name
 * restricted-name-chars =/ "+" ; Characters after last plus always
 *                              ; specify a structured syntax suffix
 * ALPHA =  %x41-5A / %x61-7A   ; A-Z / a-z
 * DIGIT =  %x30-39             ; 0-9
 */</span>
<span class="keyword">var</span> subtypeNameRegExp = <span class="regexp">/^[A-Za-z0-9][A-Za-z0-9!#$&amp;^_.-]{0,126}$/</span>
<span class="keyword">var</span> typeNameRegExp = <span class="regexp">/^[A-Za-z0-9][A-Za-z0-9!#$&amp;^_-]{0,126}$/</span>
<span class="keyword">var</span> typeRegExp = <span class="regexp">/^ *([A-Za-z0-9][A-Za-z0-9!#$&amp;^_-]{0,126})\/([A-Za-z0-9][A-Za-z0-9!#$&amp;^_.+-]{0,126}) *$/</span>;

<span class="comment">/**
 * Module exports.
 */</span>

exports.format = format
exports.parse = parse

<span class="comment">/**
 * Format object to media type.
 *
 * @param {object} obj
 * @return {string}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">format</span><span class="params">(obj)</span> {</span>
  <span class="keyword">if</span> (!obj || <span class="keyword">typeof</span> obj !== <span class="string">'object'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument obj is required'</span>)
  }

  <span class="keyword">var</span> parameters = obj.parameters
  <span class="keyword">var</span> subtype = obj.subtype
  <span class="keyword">var</span> suffix = obj.suffix
  <span class="keyword">var</span> type = obj.type

  <span class="keyword">if</span> (!type || !typeNameRegExp.test(type)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid type'</span>)
  }

  <span class="keyword">if</span> (!subtype || !subtypeNameRegExp.test(subtype)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid subtype'</span>)
  }

  <span class="comment">// format as type/subtype</span>
  <span class="keyword">var</span> string = type + <span class="string">'/'</span> + subtype

  <span class="comment">// append +suffix</span>
  <span class="keyword">if</span> (suffix) {
    <span class="keyword">if</span> (!typeNameRegExp.test(suffix)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid suffix'</span>)
    }

    string += <span class="string">'+'</span> + suffix
  }

  <span class="comment">// append parameters</span>
  <span class="keyword">if</span> (parameters &amp;&amp; <span class="keyword">typeof</span> parameters === <span class="string">'object'</span>) {
    <span class="keyword">var</span> param
    <span class="keyword">var</span> params = Object.keys(parameters).sort()

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; params.length; i++) {
      param = params[i]

      <span class="keyword">if</span> (!tokenRegExp.test(param)) {
        <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid parameter name'</span>)
      }

      string += <span class="string">'; '</span> + param + <span class="string">'='</span> + qstring(parameters[param])
    }
  }

  <span class="keyword">return</span> string
}

<span class="comment">/**
 * Parse media type to object.
 *
 * @param {string|object} string
 * @return {Object}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">(string)</span> {</span>
  <span class="keyword">if</span> (!string) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument string is required'</span>)
  }

  <span class="comment">// support req/res-like objects as argument</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> string === <span class="string">'object'</span>) {
    string = getcontenttype(string)
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> string !== <span class="string">'string'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument string is required to be a string'</span>)
  }

  <span class="keyword">var</span> index = string.indexOf(<span class="string">';'</span>)
  <span class="keyword">var</span> type = index !== -<span class="number">1</span>
    ? string.substr(<span class="number">0</span>, index)
    : string

  <span class="keyword">var</span> key
  <span class="keyword">var</span> match
  <span class="keyword">var</span> obj = splitType(type)
  <span class="keyword">var</span> params = {}
  <span class="keyword">var</span> value

  paramRegExp.lastIndex = index

  <span class="keyword">while</span> (match = paramRegExp.exec(string)) {
    <span class="keyword">if</span> (match.index !== index) {
      <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid parameter format'</span>)
    }

    index += match[<span class="number">0</span>].length
    key = match[<span class="number">1</span>].toLowerCase()
    value = match[<span class="number">2</span>]

    <span class="keyword">if</span> (value[<span class="number">0</span>] === <span class="string">'"'</span>) {
      <span class="comment">// remove quotes and escapes</span>
      value = value
        .substr(<span class="number">1</span>, value.length - <span class="number">2</span>)
        .replace(qescRegExp, <span class="string">'$1'</span>)
    }

    params[key] = value
  }

  <span class="keyword">if</span> (index !== -<span class="number">1</span> &amp;&amp; index !== string.length) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid parameter format'</span>)
  }

  obj.parameters = params

  <span class="keyword">return</span> obj
}

<span class="comment">/**
 * Get content-type from req/res objects.
 *
 * @param {object}
 * @return {Object}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">getcontenttype</span><span class="params">(obj)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj.getHeader === <span class="string">'function'</span>) {
    <span class="comment">// res-like</span>
    <span class="keyword">return</span> obj.getHeader(<span class="string">'content-type'</span>)
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj.headers === <span class="string">'object'</span>) {
    <span class="comment">// req-like</span>
    <span class="keyword">return</span> obj.headers &amp;&amp; obj.headers[<span class="string">'content-type'</span>]
  }
}

<span class="comment">/**
 * Quote a string if necessary.
 *
 * @param {string} val
 * @return {string}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">qstring</span><span class="params">(val)</span> {</span>
  <span class="keyword">var</span> str = String(val)

  <span class="comment">// no need to quote tokens</span>
  <span class="keyword">if</span> (tokenRegExp.test(str)) {
    <span class="keyword">return</span> str
  }

  <span class="keyword">if</span> (str.length > <span class="number">0</span> &amp;&amp; !textRegExp.test(str)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid parameter value'</span>)
  }

  <span class="keyword">return</span> <span class="string">'"'</span> + str.replace(quoteRegExp, <span class="string">'\\$1'</span>) + <span class="string">'"'</span>
}

<span class="comment">/**
 * Simply "type/subtype+siffx" into parts.
 *
 * @param {string} string
 * @return {Object}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">splitType</span><span class="params">(string)</span> {</span>
  <span class="keyword">var</span> match = typeRegExp.exec(string.toLowerCase())

  <span class="keyword">if</span> (!match) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'invalid media type'</span>)
  }

  <span class="keyword">var</span> type = match[<span class="number">1</span>]
  <span class="keyword">var</span> subtype = match[<span class="number">2</span>]
  <span class="keyword">var</span> suffix

  <span class="comment">// suffix after last +</span>
  <span class="keyword">var</span> index = subtype.lastIndexOf(<span class="string">'+'</span>)
  <span class="keyword">if</span> (index !== -<span class="number">1</span>) {
    suffix = subtype.substr(index + <span class="number">1</span>)
    subtype = subtype.substr(<span class="number">0</span>, index)
  }

  <span class="keyword">var</span> obj = {
    type: type,
    subtype: subtype,
    suffix: suffix
  }

  <span class="keyword">return</span> obj
}
</code></pre>