<h1>utils.js</h1>
<pre><code class="lang-js"><span class="comment">// Load modules</span>


<span class="comment">// Declare internals</span>

<span class="keyword">var</span> internals = {};


exports.arrayToObject = <span class="function"><span class="keyword">function</span> <span class="params">(source)</span> {</span>

    <span class="keyword">var</span> obj = {};
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, il = source.length; i &lt; il; ++i) {
        <span class="keyword">if</span> (<span class="keyword">typeof</span> source[i] !== <span class="string">'undefined'</span>) {

            obj[i] = source[i];
        }
    }

    <span class="keyword">return</span> obj;
};


exports.merge = <span class="function"><span class="keyword">function</span> <span class="params">(target, source)</span> {</span>

    <span class="keyword">if</span> (!source) {
        <span class="keyword">return</span> target;
    }

    <span class="keyword">if</span> (Array.isArray(source)) {
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, il = source.length; i &lt; il; ++i) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> source[i] !== <span class="string">'undefined'</span>) {
                <span class="keyword">if</span> (<span class="keyword">typeof</span> target[i] === <span class="string">'object'</span>) {
                    target[i] = exports.merge(target[i], source[i]);
                }
                <span class="keyword">else</span> {
                    target[i] = source[i];
                }
            }
        }

        <span class="keyword">return</span> target;
    }

    <span class="keyword">if</span> (Array.isArray(target)) {
        <span class="keyword">if</span> (<span class="keyword">typeof</span> source !== <span class="string">'object'</span>) {
            target.push(source);
            <span class="keyword">return</span> target;
        }
        <span class="keyword">else</span> {
            target = exports.arrayToObject(target);
        }
    }

    <span class="keyword">var</span> keys = Object.keys(source);
    <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>, kl = keys.length; k &lt; kl; ++k) {
        <span class="keyword">var</span> key = keys[k];
        <span class="keyword">var</span> value = source[key];

        <span class="keyword">if</span> (value &amp;&amp;
            <span class="keyword">typeof</span> value === <span class="string">'object'</span>) {

            <span class="keyword">if</span> (!target[key]) {
                target[key] = value;
            }
            <span class="keyword">else</span> {
                target[key] = exports.merge(target[key], value);
            }
        }
        <span class="keyword">else</span> {
            target[key] = value;
        }
    }

    <span class="keyword">return</span> target;
};


exports.decode = <span class="function"><span class="keyword">function</span> <span class="params">(str)</span> {</span>

    <span class="keyword">try</span> {
        <span class="keyword">return</span> decodeURIComponent(str.replace(<span class="regexp">/\+/g</span>, <span class="string">' '</span>));
    } <span class="keyword">catch</span> (e) {
        <span class="keyword">return</span> str;
    }
};


exports.compact = <span class="function"><span class="keyword">function</span> <span class="params">(obj, refs)</span> {</span>

    <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">'object'</span> ||
        obj === <span class="literal">null</span>) {

        <span class="keyword">return</span> obj;
    }

    refs = refs || [];
    <span class="keyword">var</span> lookup = refs.indexOf(obj);
    <span class="keyword">if</span> (lookup !== -<span class="number">1</span>) {
        <span class="keyword">return</span> refs[lookup];
    }

    refs.push(obj);

    <span class="keyword">if</span> (Array.isArray(obj)) {
        <span class="keyword">var</span> compacted = [];

        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = obj.length; i &lt; l; ++i) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> obj[i] !== <span class="string">'undefined'</span>) {
                compacted.push(obj[i]);
            }
        }

        <span class="keyword">return</span> compacted;
    }

    <span class="keyword">var</span> keys = Object.keys(obj);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, il = keys.length; i &lt; il; ++i) {
        <span class="keyword">var</span> key = keys[i];
        obj[key] = exports.compact(obj[key], refs);
    }

    <span class="keyword">return</span> obj;
};


exports.isRegExp = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
    <span class="keyword">return</span> Object.prototype.toString.call(obj) === <span class="string">'[object RegExp]'</span>;
};


exports.isBuffer = <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>

    <span class="keyword">if</span> (<span class="keyword">typeof</span> Buffer !== <span class="string">'undefined'</span>) {
        <span class="keyword">return</span> Buffer.isBuffer(obj);
    }
    <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
};
</code></pre>