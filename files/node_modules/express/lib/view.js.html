<h1>view.js</h1>
<pre><code class="lang-js"><span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>);
<span class="keyword">var</span> dirname = path.dirname;
<span class="keyword">var</span> basename = path.basename;
<span class="keyword">var</span> extname = path.extname;
<span class="keyword">var</span> exists = fs.existsSync || path.existsSync;
<span class="keyword">var</span> join = path.join;

<span class="comment">/**
 * Expose `View`.
 */</span>

module.exports = View;

<span class="comment">/**
 * Initialize a new `View` with the given `name`.
 *
 * Options:
 *
 *   - `defaultEngine` the default template engine name
 *   - `engines` template engine require() cache
 *   - `root` root path for view lookup
 *
 * @param {String} name
 * @param {Object} options
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">View</span><span class="params">(name, options)</span> {</span>
  options = options || {};
  <span class="keyword">this</span>.name = name;
  <span class="keyword">this</span>.root = options.root;
  <span class="keyword">var</span> engines = options.engines;
  <span class="keyword">this</span>.defaultEngine = options.defaultEngine;
  <span class="keyword">var</span> ext = <span class="keyword">this</span>.ext = extname(name);
  <span class="keyword">if</span> (!ext &amp;&amp; !<span class="keyword">this</span>.defaultEngine) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'No default engine was specified and no extension was provided.'</span>);
  <span class="keyword">if</span> (!ext) name += (ext = <span class="keyword">this</span>.ext = (<span class="string">'.'</span> != <span class="keyword">this</span>.defaultEngine[<span class="number">0</span>] ? <span class="string">'.'</span> : <span class="string">''</span>) + <span class="keyword">this</span>.defaultEngine);
  <span class="keyword">this</span>.engine = engines[ext] || (engines[ext] = require(ext.slice(<span class="number">1</span>)).__express);
  <span class="keyword">this</span>.path = <span class="keyword">this</span>.lookup(name);
}

<span class="comment">/**
 * Lookup view by the given `path`
 *
 * @param {String} path
 * @return {String}
 * @api private
 */</span>

View.prototype.lookup = <span class="keyword">function</span>(path){
  <span class="keyword">var</span> ext = <span class="keyword">this</span>.ext;

  <span class="comment">// &lt;path>.&lt;engine></span>
  <span class="keyword">if</span> (!utils.isAbsolute(path)) path = join(<span class="keyword">this</span>.root, path);
  <span class="keyword">if</span> (exists(path)) <span class="keyword">return</span> path;

  <span class="comment">// &lt;path>/index.&lt;engine></span>
  path = join(dirname(path), basename(path, ext), <span class="string">'index'</span> + ext);
  <span class="keyword">if</span> (exists(path)) <span class="keyword">return</span> path;
};

<span class="comment">/**
 * Render with the given `options` and callback `fn(err, str)`.
 *
 * @param {Object} options
 * @param {Function} fn
 * @api private
 */</span>

View.prototype.render = <span class="keyword">function</span>(options, fn){
  <span class="keyword">this</span>.engine(<span class="keyword">this</span>.path, options, fn);
};
</code></pre>