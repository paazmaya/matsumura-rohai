<h1>layer.js</h1>
<pre><code class="lang-js"><span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> pathRegexp = require(<span class="string">'path-to-regexp'</span>);
<span class="keyword">var</span> debug = require(<span class="string">'debug'</span>)(<span class="string">'express:router:layer'</span>);

<span class="comment">/**
 * Module variables.
 */</span>

<span class="keyword">var</span> hasOwnProperty = Object.prototype.hasOwnProperty;

<span class="comment">/**
 * Expose `Layer`.
 */</span>

module.exports = Layer;

<span class="function"><span class="keyword">function</span> <span class="title">Layer</span><span class="params">(path, options, fn)</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Layer)) {
    <span class="keyword">return</span> <span class="keyword">new</span> Layer(path, options, fn);
  }

  debug(<span class="string">'new %s'</span>, path);
  options = options || {};

  <span class="keyword">this</span>.handle = fn;
  <span class="keyword">this</span>.name = fn.name || <span class="string">'&lt;anonymous>'</span>;
  <span class="keyword">this</span>.params = <span class="literal">undefined</span>;
  <span class="keyword">this</span>.path = <span class="literal">undefined</span>;
  <span class="keyword">this</span>.regexp = pathRegexp(path, <span class="keyword">this</span>.keys = [], options);

  <span class="keyword">if</span> (path === <span class="string">'/'</span> &amp;&amp; options.end === <span class="literal">false</span>) {
    <span class="keyword">this</span>.regexp.fast_slash = <span class="literal">true</span>;
  }
}

<span class="comment">/**
 * Handle the error for the layer.
 *
 * @param {Error} error
 * @param {Request} req
 * @param {Response} res
 * @param {function} next
 * @api private
 */</span>

Layer.prototype.handle_error = <span class="function"><span class="keyword">function</span> <span class="title">handle_error</span><span class="params">(error, req, res, next)</span> {</span>
  <span class="keyword">var</span> fn = <span class="keyword">this</span>.handle;

  <span class="keyword">if</span> (fn.length !== <span class="number">4</span>) {
    <span class="comment">// not a standard error handler</span>
    <span class="keyword">return</span> next(error);
  }

  <span class="keyword">try</span> {
    fn(error, req, res, next);
  } <span class="keyword">catch</span> (err) {
    next(err);
  }
};

<span class="comment">/**
 * Handle the request for the layer.
 *
 * @param {Request} req
 * @param {Response} res
 * @param {function} next
 * @api private
 */</span>

Layer.prototype.handle_request = <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(req, res, next)</span> {</span>
  <span class="keyword">var</span> fn = <span class="keyword">this</span>.handle;

  <span class="keyword">if</span> (fn.length > <span class="number">3</span>) {
    <span class="comment">// not a standard request handler</span>
    <span class="keyword">return</span> next();
  }

  <span class="keyword">try</span> {
    fn(req, res, next);
  } <span class="keyword">catch</span> (err) {
    next(err);
  }
};

<span class="comment">/**
 * Check if this route matches `path`, if so
 * populate `.params`.
 *
 * @param {String} path
 * @return {Boolean}
 * @api private
 */</span>

Layer.prototype.match = <span class="function"><span class="keyword">function</span> <span class="title">match</span><span class="params">(path)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.regexp.fast_slash) {
    <span class="comment">// fast path non-ending match for / (everything matches)</span>
    <span class="keyword">this</span>.params = {};
    <span class="keyword">this</span>.path = <span class="string">''</span>;
    <span class="keyword">return</span> <span class="literal">true</span>;
  }

  <span class="keyword">var</span> m = <span class="keyword">this</span>.regexp.exec(path);

  <span class="keyword">if</span> (!m) {
    <span class="keyword">this</span>.params = <span class="literal">undefined</span>;
    <span class="keyword">this</span>.path = <span class="literal">undefined</span>;
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="comment">// store values</span>
  <span class="keyword">this</span>.params = {};
  <span class="keyword">this</span>.path = m[<span class="number">0</span>];

  <span class="keyword">var</span> keys = <span class="keyword">this</span>.keys;
  <span class="keyword">var</span> params = <span class="keyword">this</span>.params;
  <span class="keyword">var</span> prop;
  <span class="keyword">var</span> n = <span class="number">0</span>;
  <span class="keyword">var</span> key;
  <span class="keyword">var</span> val;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>, len = m.length; i &lt; len; ++i) {
    key = keys[i - <span class="number">1</span>];
    prop = key
      ? key.name
      : n++;
    val = decode_param(m[i]);

    <span class="keyword">if</span> (val !== <span class="literal">undefined</span> || !(hasOwnProperty.call(params, prop))) {
      params[prop] = val;
    }
  }

  <span class="keyword">return</span> <span class="literal">true</span>;
};

<span class="comment">/**
 * Decode param value.
 *
 * @param {string} val
 * @return {string}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">decode_param</span><span class="params">(val)</span>{</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> val !== <span class="string">'string'</span>) {
    <span class="keyword">return</span> val;
  }

  <span class="keyword">try</span> {
    <span class="keyword">return</span> decodeURIComponent(val);
  } <span class="keyword">catch</span> (e) {
    <span class="keyword">var</span> err = <span class="keyword">new</span> TypeError(<span class="string">"Failed to decode param '"</span> + val + <span class="string">"'"</span>);
    err.status = <span class="number">400</span>;
    <span class="keyword">throw</span> err;
  }
}
</code></pre>