<h1>mstranslator</h1>
<pre><code class="lang-js"><span class="keyword">var</span> querystring = require(<span class="string">'querystring'</span>);
<span class="keyword">var</span> http = require(<span class="string">'http'</span>);
<span class="keyword">var</span> https = require(<span class="string">'https'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">MsTranslator</span><span class="params">(credentials)</span>{</span>
  <span class="keyword">this</span>.credentials = credentials;
  <span class="keyword">this</span>.access_token = <span class="string">""</span>;
  <span class="keyword">this</span>.expired_in = <span class="literal">null</span>;
  
  <span class="keyword">this</span>.options = {
    host: <span class="string">'datamarket.accesscontrol.windows.net'</span>,
    path: <span class="string">'/v2/OAuth2-13'</span>,
    method: <span class="string">'POST'</span>,
  };
  <span class="keyword">this</span>.mstrans = {
    host: <span class="string">'api.microsofttranslator.com'</span>,
    method: <span class="string">'GET'</span>,
    headers: {}
  };

  <span class="comment">// use the ajax endpoint so that the responses are JSON</span>
  <span class="keyword">this</span>.ajax_root = <span class="string">'/V2/Ajax.svc/'</span>;
  <span class="keyword">this</span>.http_root = <span class="string">'/V2/Http.svc/'</span>;
  
  <span class="keyword">this</span>.query = {
    grant_type: <span class="string">'client_credentials'</span>,
    scope: <span class="string">'http://api.microsofttranslator.com'</span>
  };

}


module.exports = MsTranslator;


MsTranslator.prototype.printArray = <span class="keyword">function</span>(arr)
{
  <span class="keyword">var</span> arrval = arr.join(<span class="string">'","'</span>);
  <span class="keyword">return</span> <span class="string">'["'</span> + arrval + <span class="string">'"]'</span>;
}

MsTranslator.prototype.convertArrays = <span class="keyword">function</span>(obj)
{
  <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> obj) {
    <span class="keyword">if</span> (Array.isArray(obj[prop])) {
      obj[prop] = <span class="keyword">this</span>.printArray(obj[prop]);
    }
  }
  <span class="keyword">return</span> obj;
}

MsTranslator.prototype.initialize_token = <span class="keyword">function</span>(callback){
  <span class="keyword">var</span> self = <span class="keyword">this</span>;
  <span class="keyword">var</span> req = https.request(self.options, <span class="keyword">function</span>(res) {
    res.setEncoding(<span class="string">'utf8'</span>);
    <span class="keyword">var</span> data = <span class="string">''</span>;
    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(chunk)</span> {</span>
      data += chunk;
    });
    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> keys = JSON.parse(data);
      self.access_token = keys.access_token;
      self.expires_in = (parseInt(keys.expires_in) - <span class="number">10</span>) * <span class="number">1000</span>;
      setTimeout(<span class="keyword">function</span>() {self.initialize_token()}, self.expires_in);
      <span class="keyword">if</span>(callback != <span class="literal">undefined</span>) {
        callback(keys);
      }
    });
  });
  
  <span class="keyword">this</span>.query.client_id = self.credentials.client_id;
  <span class="keyword">this</span>.query.client_secret = self.credentials.client_secret;
  req.write(querystring.stringify(<span class="keyword">this</span>.query));
  req.end();
}

MsTranslator.prototype.call = <span class="keyword">function</span>(path, params, fn) {
  <span class="keyword">var</span> settings = <span class="keyword">this</span>.mstrans;
  settings.headers.Authorization = <span class="string">'Bearer '</span> + <span class="keyword">this</span>.access_token;
  params = <span class="keyword">this</span>.convertArrays(params);
  settings.path= <span class="keyword">this</span>.ajax_root + path + <span class="string">'?'</span> + querystring.stringify(params);
  <span class="keyword">var</span> req = http.request(settings, <span class="keyword">function</span>(res) {
    res.setEncoding(<span class="string">'utf8'</span>);
    <span class="keyword">var</span> body = <span class="string">''</span>;
    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(chunk)</span> {</span>
      body += chunk;
    });
    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="comment">//remove invalid BOM</span>
      body = body.substring(<span class="number">1</span>, body.length);
      <span class="keyword">try</span> {
        <span class="keyword">if</span> (body.indexOf(<span class="string">'ArgumentException:'</span>) === <span class="number">1</span>) {
          fn(body, JSON.parse(body));
        } <span class="keyword">else</span> {
          fn(<span class="literal">null</span>, JSON.parse(body));
        }
      } <span class="keyword">catch</span> (e) {
        fn(e, <span class="literal">null</span>);
      }
    });
  });
  req.end();
};

MsTranslator.prototype.call_speak = <span class="keyword">function</span>(path, params,  fn) {
  <span class="keyword">var</span> settings = <span class="keyword">this</span>.mstrans;
  settings.headers.Authorization = <span class="string">'Bearer '</span> + <span class="keyword">this</span>.access_token;
  params = <span class="keyword">this</span>.convertArrays(params);
  settings.path= <span class="keyword">this</span>.http_root + path + <span class="string">'?'</span> + querystring.stringify(params);
  <span class="keyword">var</span> req = http.request(settings, <span class="keyword">function</span>(res) {
    
    <span class="keyword">var</span> buffers = [];

    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(chunk)</span> {</span>
      <span class="keyword">if</span>(!Buffer.isBuffer(chunk)){
        chunk = <span class="keyword">new</span> Buffer(chunk);
      }
      buffers.push(chunk);
    });
    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> index = <span class="number">0</span>;
      <span class="keyword">var</span> buffer_length = buffers.reduce(<span class="keyword">function</span>(sum, e) { <span class="keyword">return</span> sum += e.length }, <span class="number">0</span>);
      <span class="keyword">var</span> body = <span class="keyword">new</span> Buffer(buffer_length);
      buffers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(buf, i)</span> {</span>
        buf.copy(body, index, <span class="number">0</span>, buf.length);
        index += buf.length;
      });
      <span class="keyword">delete</span>(buffers);
      fn(<span class="literal">null</span>, body);
    });
  });
  req.end();
};

<span class="comment">// BreakSentences Method</span>
<span class="comment">// params { text, language }</span>
MsTranslator.prototype.breakSentences = <span class="keyword">function</span>(params,  fn) {
  <span class="keyword">this</span>.call(<span class="string">'BreakSentences'</span>, params,  fn);
};

<span class="comment">// Detect Method</span>
<span class="comment">// params { text }</span>
MsTranslator.prototype.detect = <span class="keyword">function</span>(params,  fn) {
  <span class="keyword">this</span>.call(<span class="string">'Detect'</span>, params,  fn);
};

<span class="comment">// DetectArray Method</span>
<span class="comment">// params { texts }</span>
MsTranslator.prototype.detectArray = <span class="keyword">function</span>(params,  fn) {
  <span class="keyword">this</span>.call(<span class="string">'DetectArray'</span>, params,  fn);
};

<span class="comment">// GetLanguageNames Method</span>
<span class="comment">// params { locale, languageCodes }</span>
MsTranslator.prototype.getLanguageNames = <span class="keyword">function</span>(params, fn) {
  <span class="keyword">this</span>.call(<span class="string">'GetLanguageNames'</span>, params, fn);
};

<span class="comment">// GetLanguagesForSpeak Method</span>
<span class="comment">// params { }</span>
MsTranslator.prototype.getLanguagesForSpeak = <span class="keyword">function</span>(fn) {
  <span class="keyword">this</span>.call(<span class="string">'GetLanguagesForSpeak'</span>, {}, fn);
};

<span class="comment">// GetLanguagesForTranslate Method</span>
<span class="comment">// params { }</span>
MsTranslator.prototype.getLanguagesForTranslate = <span class="keyword">function</span>(fn) {
  <span class="keyword">this</span>.call(<span class="string">'GetLanguagesForTranslate'</span>, {}, fn);
};

<span class="comment">// GetTranslations Method</span>
<span class="comment">// params { text, from, to, maxTranslations, options }</span>
MsTranslator.prototype.getTranslations = <span class="keyword">function</span>(params, fn) {
  <span class="keyword">this</span>.call(<span class="string">'GetTranslations'</span>, params, fn);
};

<span class="comment">// GetTranslationsArray Method</span>
<span class="comment">// params { text, from, to, maxTranslations, options }</span>
MsTranslator.prototype.getTranslationsArray = <span class="keyword">function</span>(params, fn) {
  <span class="keyword">this</span>.call(<span class="string">'GetTranslationsArray'</span>, params, fn);
};

<span class="comment">// Speak Method</span>
<span class="comment">// params { text, language, format }</span>
MsTranslator.prototype.speak = <span class="keyword">function</span>(params, fn) {
  <span class="keyword">this</span>.call_speak(<span class="string">'Speak'</span>, params, fn);
};

<span class="comment">// Translate Method</span>
<span class="comment">// params { text, from, to, contentType, category }</span>
MsTranslator.prototype.translate = <span class="keyword">function</span>(params, fn) {
  <span class="keyword">this</span>.call(<span class="string">'Translate'</span>, params, fn);
};

<span class="comment">// TranslateArray Method</span>
<span class="comment">// params { textss, from, to, options }</span>
MsTranslator.prototype.translateArray = <span class="keyword">function</span>(params, fn) {
  <span class="keyword">this</span>.call(<span class="string">'TranslateArray'</span>, params, fn);
};
</code></pre>