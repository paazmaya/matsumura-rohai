<h1>etag</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * etag
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module exports.
 */</span>

module.exports = etag

<span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> crc = require(<span class="string">'crc'</span>).crc32
<span class="keyword">var</span> crypto = require(<span class="string">'crypto'</span>)
<span class="keyword">var</span> Stats = require(<span class="string">'fs'</span>).Stats

<span class="comment">/**
 * Module variables.
 */</span>

<span class="keyword">var</span> crc32threshold = <span class="number">1000</span> <span class="comment">// 1KB</span>
<span class="keyword">var</span> NULL = <span class="keyword">new</span> Buffer([<span class="number">0</span>])
<span class="keyword">var</span> toString = Object.prototype.toString

<span class="comment">/**
 * Create a simple ETag.
 *
 * @param {string|Buffer|Stats} entity
 * @param {object} [options]
 * @param {boolean} [options.weak]
 * @return {String}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">etag</span><span class="params">(entity, options)</span> {</span>
  <span class="keyword">if</span> (entity == <span class="literal">null</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument entity is required'</span>)
  }

  <span class="keyword">var</span> isStats = isstats(entity)
  <span class="keyword">var</span> weak = options &amp;&amp; <span class="keyword">typeof</span> options.weak === <span class="string">'boolean'</span>
    ? options.weak
    : isStats

  <span class="comment">// support fs.Stats object</span>
  <span class="keyword">if</span> (isStats) {
    <span class="keyword">return</span> stattag(entity, weak)
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> entity !== <span class="string">'string'</span> &amp;&amp; !Buffer.isBuffer(entity)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument entity must be string, Buffer, or fs.Stats'</span>)
  }

  <span class="keyword">var</span> hash = weak
    ? weakhash(entity)
    : stronghash(entity)

  <span class="keyword">return</span> weak
    ? <span class="string">'W/"'</span> + hash + <span class="string">'"'</span>
    : <span class="string">'"'</span> + hash + <span class="string">'"'</span>
}

<span class="comment">/**
 * Determine if object is a Stats object.
 *
 * @param {object} obj
 * @return {boolean}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">isstats</span><span class="params">(obj)</span> {</span>
  <span class="comment">// not even an object</span>
  <span class="keyword">if</span> (obj === <span class="literal">null</span> || <span class="keyword">typeof</span> obj !== <span class="string">'object'</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>
  }

  <span class="comment">// genuine fs.Stats</span>
  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Stats) {
    <span class="keyword">return</span> <span class="literal">true</span>
  }

  <span class="comment">// quack quack</span>
  <span class="keyword">return</span> <span class="string">'atime'</span> <span class="keyword">in</span> obj &amp;&amp; toString.call(obj.atime) === <span class="string">'[object Date]'</span>
    &amp;&amp; <span class="string">'ctime'</span> <span class="keyword">in</span> obj &amp;&amp; toString.call(obj.ctime) === <span class="string">'[object Date]'</span>
    &amp;&amp; <span class="string">'mtime'</span> <span class="keyword">in</span> obj &amp;&amp; toString.call(obj.mtime) === <span class="string">'[object Date]'</span>
    &amp;&amp; <span class="string">'ino'</span> <span class="keyword">in</span> obj &amp;&amp; <span class="keyword">typeof</span> obj.ino === <span class="string">'number'</span>
    &amp;&amp; <span class="string">'size'</span> <span class="keyword">in</span> obj &amp;&amp; <span class="keyword">typeof</span> obj.size === <span class="string">'number'</span>
}

<span class="comment">/**
 * Generate a tag for a stat.
 *
 * @param {Buffer} entity
 * @return {String}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">stattag</span><span class="params">(stat, weak)</span> {</span>
  <span class="keyword">var</span> mtime = stat.mtime.toISOString()
  <span class="keyword">var</span> size = stat.size.toString(<span class="number">16</span>)

  <span class="keyword">if</span> (weak) {
    <span class="keyword">return</span> <span class="string">'W/"'</span> + size + <span class="string">'-'</span> + crc(mtime) + <span class="string">'"'</span>
  }

  <span class="keyword">var</span> hash = crypto
    .createHash(<span class="string">'md5'</span>)
    .update(<span class="string">'file'</span>, <span class="string">'utf8'</span>)
    .update(NULL)
    .update(size, <span class="string">'utf8'</span>)
    .update(NULL)
    .update(mtime, <span class="string">'utf8'</span>)
    .digest(<span class="string">'base64'</span>)

  <span class="keyword">return</span> <span class="string">'"'</span> + hash + <span class="string">'"'</span>
}

<span class="comment">/**
 * Generate a strong hash.
 *
 * @param {Buffer} entity
 * @return {String}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">stronghash</span><span class="params">(entity)</span> {</span>
  <span class="keyword">if</span> (entity.length === <span class="number">0</span>) {
    <span class="comment">// fast-path empty</span>
    <span class="keyword">return</span> <span class="string">'1B2M2Y8AsgTpgAmY7PhCfg=='</span>
  }

  <span class="keyword">return</span> crypto
    .createHash(<span class="string">'md5'</span>)
    .update(entity, <span class="string">'utf8'</span>)
    .digest(<span class="string">'base64'</span>)
}

<span class="comment">/**
 * Generate a weak hash.
 *
 * @param {Buffer} entity
 * @return {String}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">weakhash</span><span class="params">(entity)</span> {</span>
  <span class="keyword">if</span> (entity.length === <span class="number">0</span>) {
    <span class="comment">// fast-path empty</span>
    <span class="keyword">return</span> <span class="string">'0-0'</span>
  }

  <span class="keyword">var</span> len = <span class="keyword">typeof</span> entity === <span class="string">'string'</span>
    ? Buffer.byteLength(entity, <span class="string">'utf8'</span>)
    : entity.length

  <span class="keyword">if</span> (len &lt;= crc32threshold) {
    <span class="comment">// crc32 plus length when it's fast</span>
    <span class="comment">// crc(str) only accepts utf-8 encoding</span>
    <span class="keyword">return</span> len.toString(<span class="number">16</span>) + <span class="string">'-'</span> + crc(entity).toString(<span class="number">16</span>)
  }

  <span class="comment">// use md4 for long strings</span>
  <span class="keyword">return</span> crypto
    .createHash(<span class="string">'md4'</span>)
    .update(entity, <span class="string">'utf8'</span>)
    .digest(<span class="string">'base64'</span>)
}
</code></pre>