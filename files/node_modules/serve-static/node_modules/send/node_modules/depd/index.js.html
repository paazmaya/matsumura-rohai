<h1>depd</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * depd
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> callSiteToString = require(<span class="string">'./lib/compat'</span>).callSiteToString
<span class="keyword">var</span> EventEmitter = require(<span class="string">'events'</span>).EventEmitter
<span class="keyword">var</span> relative = require(<span class="string">'path'</span>).relative

<span class="comment">/**
 * Module exports.
 */</span>

module.exports = depd

<span class="comment">/**
 * Get the path to base files on.
 */</span>

<span class="keyword">var</span> basePath = process.cwd()

<span class="comment">/**
 * Get listener count on event emitter.
 */</span>

<span class="comment">/*istanbul ignore next*/</span>
<span class="keyword">var</span> eventListenerCount = EventEmitter.listenerCount
  || <span class="function"><span class="keyword">function</span> <span class="params">(emitter, type)</span> {</span> <span class="keyword">return</span> emitter.listeners(type).length }

<span class="comment">/**
 * Determine if namespace is contained in the string.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">containsNamespace</span><span class="params">(str, namespace)</span> {</span>
  <span class="keyword">var</span> val = str.split(<span class="regexp">/[ ,]+/</span>)

  namespace = String(namespace).toLowerCase()

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span> ; i &lt; val.length; i++) {
    <span class="keyword">if</span> (!(str = val[i])) <span class="keyword">continue</span>;

    <span class="comment">// namespace contained</span>
    <span class="keyword">if</span> (str === <span class="string">'*'</span> || str.toLowerCase() === namespace) {
      <span class="keyword">return</span> <span class="literal">true</span>
    }
  }

  <span class="keyword">return</span> <span class="literal">false</span>
}

<span class="comment">/**
 * Convert a data descriptor to accessor descriptor.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">convertDataDescriptorToAccessor</span><span class="params">(obj, prop, message)</span> {</span>
  <span class="keyword">var</span> descriptor = Object.getOwnPropertyDescriptor(obj, prop)
  <span class="keyword">var</span> value = descriptor.value

  descriptor.get = <span class="function"><span class="keyword">function</span> <span class="title">getter</span><span class="params">()</span> {</span> <span class="keyword">return</span> value }

  <span class="keyword">if</span> (descriptor.writable) {
    descriptor.set = <span class="function"><span class="keyword">function</span> <span class="title">setter</span><span class="params">(val)</span> {</span> <span class="keyword">return</span> value = val }
  }

  <span class="keyword">delete</span> descriptor.value
  <span class="keyword">delete</span> descriptor.writable

  Object.defineProperty(obj, prop, descriptor)

  <span class="keyword">return</span> descriptor
}

<span class="comment">/**
 * Create arguments string to keep arity.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">createArgumentsString</span><span class="params">(arity)</span> {</span>
  <span class="keyword">var</span> str = <span class="string">''</span>

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arity; i++) {
    str += <span class="string">', arg'</span> + i
  }

  <span class="keyword">return</span> str.substr(<span class="number">2</span>)
}

<span class="comment">/**
 * Create stack string from stack.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">createStackString</span><span class="params">(stack)</span> {</span>
  <span class="keyword">var</span> str = <span class="keyword">this</span>.name + <span class="string">': '</span> + <span class="keyword">this</span>.namespace

  <span class="keyword">if</span> (<span class="keyword">this</span>.message) {
    str += <span class="string">' deprecated '</span> + <span class="keyword">this</span>.message
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.length; i++) {
    str += <span class="string">'\n    at '</span> + callSiteToString(stack[i])
  }

  <span class="keyword">return</span> str
}

<span class="comment">/**
 * Create deprecate for namespace in caller.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">depd</span><span class="params">(namespace)</span> {</span>
  <span class="keyword">if</span> (!namespace) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument namespace is required'</span>)
  }

  <span class="keyword">var</span> stack = getStack()
  <span class="keyword">var</span> site = callSiteLocation(stack[<span class="number">1</span>])
  <span class="keyword">var</span> file = site[<span class="number">0</span>]

  <span class="function"><span class="keyword">function</span> <span class="title">deprecate</span><span class="params">(message)</span> {</span>
    <span class="comment">// call to self as log</span>
    log.call(deprecate, message)
  }

  deprecate._file = file
  deprecate._ignored = isignored(namespace)
  deprecate._namespace = namespace
  deprecate._traced = istraced(namespace)
  deprecate._warned = Object.create(<span class="literal">null</span>)

  deprecate.<span class="function"><span class="keyword">function</span> = <span class="title">wrapfunction</span>
  <span class="title">deprecate</span>.<span class="title">property</span> = <span class="title">wrapproperty</span>

  <span class="title">return</span> <span class="title">deprecate</span>
}

/**
 * <span class="title">Determine</span> <span class="title">if</span> <span class="title">namespace</span> <span class="title">is</span> <span class="title">ignored</span>.
 */

<span class="title">function</span> <span class="title">isignored</span><span class="params">(namespace)</span> {</span>
  <span class="comment">/* istanbul ignore next: tested in a child processs */</span>
  <span class="keyword">if</span> (process.noDeprecation) {
    <span class="comment">// --no-deprecation support</span>
    <span class="keyword">return</span> <span class="literal">true</span>
  }

  <span class="keyword">var</span> str = process.env.NO_DEPRECATION || <span class="string">''</span>

  <span class="comment">// namespace ignored</span>
  <span class="keyword">return</span> containsNamespace(str, namespace)
}

<span class="comment">/**
 * Determine if namespace is traced.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">istraced</span><span class="params">(namespace)</span> {</span>
  <span class="comment">/* istanbul ignore next: tested in a child processs */</span>
  <span class="keyword">if</span> (process.traceDeprecation) {
    <span class="comment">// --trace-deprecation support</span>
    <span class="keyword">return</span> <span class="literal">true</span>
  }

  <span class="keyword">var</span> str = process.env.TRACE_DEPRECATION || <span class="string">''</span>

  <span class="comment">// namespace traced</span>
  <span class="keyword">return</span> containsNamespace(str, namespace)
}

<span class="comment">/**
 * Display deprecation message.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(message, site)</span> {</span>
  <span class="keyword">var</span> haslisteners = eventListenerCount(process, <span class="string">'deprecation'</span>) !== <span class="number">0</span>

  <span class="comment">// abort early if no destination</span>
  <span class="keyword">if</span> (!haslisteners &amp;&amp; <span class="keyword">this</span>._ignored) {
    <span class="keyword">return</span>
  }

  <span class="keyword">var</span> caller
  <span class="keyword">var</span> callFile
  <span class="keyword">var</span> callSite
  <span class="keyword">var</span> i = <span class="number">0</span>
  <span class="keyword">var</span> seen = <span class="literal">false</span>
  <span class="keyword">var</span> stack = getStack()
  <span class="keyword">var</span> file = <span class="keyword">this</span>._file

  <span class="keyword">if</span> (site) {
    <span class="comment">// provided site</span>
    callSite = callSiteLocation(stack[<span class="number">1</span>])
    callSite.name = site.name
    file = callSite[<span class="number">0</span>]
  } <span class="keyword">else</span> {
    <span class="comment">// get call site</span>
    i = <span class="number">2</span>
    site = callSiteLocation(stack[i])
    callSite = site
  }

  <span class="comment">// get caller of deprecated thing in relation to file</span>
  <span class="keyword">for</span> (; i &lt; stack.length; i++) {
    caller = callSiteLocation(stack[i])
    callFile = caller[<span class="number">0</span>]

    <span class="keyword">if</span> (callFile === file) {
      seen = <span class="literal">true</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (callFile === <span class="keyword">this</span>._file) {
      file = <span class="keyword">this</span>._file
    } <span class="keyword">else</span> <span class="keyword">if</span> (seen) {
      <span class="keyword">break</span>
    }
  }

  <span class="keyword">var</span> key = caller
    ? site.join(<span class="string">':'</span>) + <span class="string">'__'</span> + caller.join(<span class="string">':'</span>)
    : <span class="literal">undefined</span>

  <span class="keyword">if</span> (key !== <span class="literal">undefined</span> &amp;&amp; key <span class="keyword">in</span> <span class="keyword">this</span>._warned) {
    <span class="comment">// already warned</span>
    <span class="keyword">return</span>
  }

  <span class="keyword">this</span>._warned[key] = <span class="literal">true</span>

  <span class="comment">// generate automatic message from call site</span>
  <span class="keyword">if</span> (!message) {
    message = callSite === site || !callSite.name
      ? defaultMessage(site)
      : defaultMessage(callSite)
  }

  <span class="comment">// emit deprecation if listeners exist</span>
  <span class="keyword">if</span> (haslisteners) {
    <span class="keyword">var</span> err = DeprecationError(<span class="keyword">this</span>._namespace, message, stack.slice(i))
    process.emit(<span class="string">'deprecation'</span>, err)
    <span class="keyword">return</span>
  }

  <span class="comment">// format and write message</span>
  <span class="keyword">var</span> format = process.stderr.isTTY
    ? formatColor
    : formatPlain
  <span class="keyword">var</span> msg = format.call(<span class="keyword">this</span>, message, caller, stack.slice(i))
  process.stderr.write(msg + <span class="string">'\n'</span>, <span class="string">'utf8'</span>)

  <span class="keyword">return</span>
}

<span class="comment">/**
 * Get call site location as array.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">callSiteLocation</span><span class="params">(callSite)</span> {</span>
  <span class="keyword">var</span> file = callSite.getFileName() || <span class="string">'&lt;anonymous>'</span>
  <span class="keyword">var</span> line = callSite.getLineNumber()
  <span class="keyword">var</span> colm = callSite.getColumnNumber()

  <span class="keyword">if</span> (callSite.isEval()) {
    file = callSite.getEvalOrigin() + <span class="string">', '</span> + file
  }

  <span class="keyword">var</span> site = [file, line, colm]

  site.callSite = callSite
  site.name = callSite.getFunctionName()

  <span class="keyword">return</span> site
}

<span class="comment">/**
 * Generate a default message from the site.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">defaultMessage</span><span class="params">(site)</span> {</span>
  <span class="keyword">var</span> callSite = site.callSite
  <span class="keyword">var</span> funcName = site.name
  <span class="keyword">var</span> typeName = callSite.getTypeName()

  <span class="comment">// make useful anonymous name</span>
  <span class="keyword">if</span> (!funcName) {
    funcName = <span class="string">'&lt;anonymous@'</span> + formatLocation(site) + <span class="string">'>'</span>
  }

  <span class="comment">// make useful type name</span>
  <span class="keyword">if</span> (typeName === <span class="string">'Function'</span>) {
    typeName = callSite.getThis().name || typeName
  }

  <span class="keyword">return</span> callSite.getMethodName()
    ? typeName + <span class="string">'.'</span> + funcName
    : funcName
}

<span class="comment">/**
 * Format deprecation message without color.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">formatPlain</span><span class="params">(msg, caller, stack)</span> {</span>
  <span class="keyword">var</span> timestamp = <span class="keyword">new</span> Date().toUTCString()

  <span class="keyword">var</span> formatted = timestamp
    + <span class="string">' '</span> + <span class="keyword">this</span>._namespace
    + <span class="string">' deprecated '</span> + msg

  <span class="comment">// add stack trace</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._traced) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.length; i++) {
      formatted += <span class="string">'\n    at '</span> + callSiteToString(stack[i])
    }

    <span class="keyword">return</span> formatted
  }

  <span class="keyword">if</span> (caller) {
    formatted += <span class="string">' at '</span> + formatLocation(caller)
  }

  <span class="keyword">return</span> formatted
}

<span class="comment">/**
 * Format deprecation message with color.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">formatColor</span><span class="params">(msg, caller, stack)</span> {</span>
  <span class="keyword">var</span> formatted = <span class="string">'\x1b[36;1m'</span> + <span class="keyword">this</span>._namespace + <span class="string">'\x1b[22;39m'</span> <span class="comment">// bold cyan</span>
    + <span class="string">' \x1b[33;1mdeprecated\x1b[22;39m'</span> <span class="comment">// bold yellow</span>
    + <span class="string">' \x1b[0m'</span> + msg + <span class="string">'\x1b[39m'</span> <span class="comment">// reset</span>

  <span class="comment">// add stack trace</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._traced) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stack.length; i++) {
      formatted += <span class="string">'\n    \x1b[36mat '</span> + callSiteToString(stack[i]) + <span class="string">'\x1b[39m'</span> <span class="comment">// cyan</span>
    }

    <span class="keyword">return</span> formatted
  }

  <span class="keyword">if</span> (caller) {
    formatted += <span class="string">' \x1b[36m'</span> + formatLocation(caller) + <span class="string">'\x1b[39m'</span> <span class="comment">// cyan</span>
  }

  <span class="keyword">return</span> formatted
}

<span class="comment">/**
 * Format call site location.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">formatLocation</span><span class="params">(callSite)</span> {</span>
  <span class="keyword">return</span> relative(basePath, callSite[<span class="number">0</span>])
    + <span class="string">':'</span> + callSite[<span class="number">1</span>]
    + <span class="string">':'</span> + callSite[<span class="number">2</span>]
}

<span class="comment">/**
 * Get the stack as array of call sites.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">getStack</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> limit = Error.stackTraceLimit
  <span class="keyword">var</span> obj = {}
  <span class="keyword">var</span> prep = Error.prepareStackTrace

  Error.prepareStackTrace = prepareObjectStackTrace
  Error.stackTraceLimit = Math.max(<span class="number">10</span>, limit)

  <span class="comment">// capture the stack</span>
  Error.captureStackTrace(obj)

  <span class="comment">// slice this function off the top</span>
  <span class="keyword">var</span> stack = obj.stack.slice(<span class="number">1</span>)

  Error.prepareStackTrace = prep
  Error.stackTraceLimit = limit

  <span class="keyword">return</span> stack
}

<span class="comment">/**
 * Capture call site stack from v8.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">prepareObjectStackTrace</span><span class="params">(obj, stack)</span> {</span>
  <span class="keyword">return</span> stack
}

<span class="comment">/**
 * Return a wrapped function in a deprecation message.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">wrapfunction</span><span class="params">(fn, message)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument fn must be a function'</span>)
  }

  <span class="keyword">var</span> args = createArgumentsString(fn.length)
  <span class="keyword">var</span> deprecate = <span class="keyword">this</span>
  <span class="keyword">var</span> stack = getStack()
  <span class="keyword">var</span> site = callSiteLocation(stack[<span class="number">1</span>])

  site.name = fn.name

  <span class="keyword">var</span> deprecatedfn = eval(<span class="string">'(function ('</span> + args + <span class="string">') {\n'</span>
    + <span class="string">'"use strict"\n'</span>
    + <span class="string">'log.call(deprecate, message, site)\n'</span>
    + <span class="string">'return fn.apply(this, arguments)\n'</span>
    + <span class="string">'})'</span>)

  <span class="keyword">return</span> deprecatedfn
}

<span class="comment">/**
 * Wrap property in a deprecation message.
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">wrapproperty</span><span class="params">(obj, prop, message)</span> {</span>
  <span class="keyword">if</span> (!obj || (<span class="keyword">typeof</span> obj !== <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> obj !== <span class="string">'function'</span>)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'argument obj must be object'</span>)
  }

  <span class="keyword">var</span> descriptor = Object.getOwnPropertyDescriptor(obj, prop)

  <span class="keyword">if</span> (!descriptor) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'must call property on owner object'</span>)
  }

  <span class="keyword">if</span> (!descriptor.configurable) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'property must be configurable'</span>)
  }

  <span class="keyword">var</span> deprecate = <span class="keyword">this</span>
  <span class="keyword">var</span> stack = getStack()
  <span class="keyword">var</span> site = callSiteLocation(stack[<span class="number">1</span>])

  <span class="comment">// set site name</span>
  site.name = prop

  <span class="comment">// convert data descriptor</span>
  <span class="keyword">if</span> (<span class="string">'value'</span> <span class="keyword">in</span> descriptor) {
    descriptor = convertDataDescriptorToAccessor(obj, prop, message)
  }

  <span class="keyword">var</span> get = descriptor.get
  <span class="keyword">var</span> set = descriptor.set

  <span class="comment">// wrap getter</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> get === <span class="string">'function'</span>) {
    descriptor.get = <span class="function"><span class="keyword">function</span> <span class="title">getter</span><span class="params">()</span> {</span>
      log.call(deprecate, message, site)
      <span class="keyword">return</span> get.apply(<span class="keyword">this</span>, arguments)
    }
  }

  <span class="comment">// wrap setter</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> set === <span class="string">'function'</span>) {
    descriptor.set = <span class="function"><span class="keyword">function</span> <span class="title">setter</span><span class="params">()</span> {</span>
      log.call(deprecate, message, site)
      <span class="keyword">return</span> set.apply(<span class="keyword">this</span>, arguments)
    }
  }

  Object.defineProperty(obj, prop, descriptor)
}

<span class="comment">/**
 * Create DeprecationError for deprecation
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">DeprecationError</span><span class="params">(namespace, message, stack)</span> {</span>
  <span class="keyword">var</span> error = <span class="keyword">new</span> Error()
  <span class="keyword">var</span> stackString

  Object.defineProperty(error, <span class="string">'constructor'</span>, {
    value: DeprecationError
  })

  Object.defineProperty(error, <span class="string">'message'</span>, {
    configurable: <span class="literal">true</span>,
    enumerable: <span class="literal">false</span>,
    value: message,
    writable: <span class="literal">true</span>
  })

  Object.defineProperty(error, <span class="string">'name'</span>, {
    enumerable: <span class="literal">false</span>,
    configurable: <span class="literal">true</span>,
    value: <span class="string">'DeprecationError'</span>,
    writable: <span class="literal">true</span>
  })

  Object.defineProperty(error, <span class="string">'namespace'</span>, {
    configurable: <span class="literal">true</span>,
    enumerable: <span class="literal">false</span>,
    value: namespace,
    writable: <span class="literal">true</span>
  })

  Object.defineProperty(error, <span class="string">'stack'</span>, {
    configurable: <span class="literal">true</span>,
    enumerable: <span class="literal">false</span>,
    get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (stackString !== <span class="literal">undefined</span>) {
        <span class="keyword">return</span> stackString
      }

      <span class="comment">// prepare stack trace</span>
      <span class="keyword">return</span> stackString = createStackString.call(<span class="keyword">this</span>, stack)
    },
    set: <span class="function"><span class="keyword">function</span> <span class="title">setter</span><span class="params">(val)</span> {</span>
      stackString = val
    }
  })

  <span class="keyword">return</span> error
}
</code></pre>