<h1>on-finished</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * on-finished
 * Copyright(c) 2013 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module exports.
 */</span>

module.exports = onFinished;
module.exports.isFinished = isFinished;

<span class="comment">/**
* Module dependencies.
*/</span>

<span class="keyword">var</span> first = require(<span class="string">'ee-first'</span>)

<span class="comment">/**
* Variables.
*/</span>

<span class="comment">/* istanbul ignore next */</span>
<span class="keyword">var</span> defer = <span class="keyword">typeof</span> setImmediate === <span class="string">'function'</span>
  ? setImmediate
  : <span class="keyword">function</span>(fn){ process.nextTick(fn.bind.apply(fn, arguments)) }

<span class="comment">/**
 * Invoke callback when the response has finished, useful for
 * cleaning up resources afterwards.
 *
 * @param {object} msg
 * @param {function} listener
 * @return {object}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">onFinished</span><span class="params">(msg, listener)</span> {</span>
  <span class="keyword">if</span> (isFinished(msg) !== <span class="literal">false</span>) {
    defer(listener)
    <span class="keyword">return</span> msg
  }

  <span class="comment">// attach the listener to the message</span>
  attachListener(msg, listener)

  <span class="keyword">return</span> msg
}

<span class="comment">/**
 * Determine is message is already finished.
 *
 * @param {object} msg
 * @return {boolean}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">isFinished</span><span class="params">(msg)</span> {</span>
  <span class="keyword">var</span> socket = msg.socket

  <span class="keyword">if</span> (<span class="keyword">typeof</span> msg.finished === <span class="string">'boolean'</span>) {
    <span class="comment">// OutgoingMessage</span>
    <span class="keyword">return</span> Boolean(!socket || msg.finished || !socket.writable)
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> msg.complete === <span class="string">'boolean'</span>) {
    <span class="comment">// IncomingMessage</span>
    <span class="keyword">return</span> Boolean(!socket || msg.complete || !socket.readable)
  }

  <span class="comment">// don't know</span>
  <span class="keyword">return</span> <span class="literal">undefined</span>
}

<span class="comment">/**
 * Attach the listener to the message.
 *
 * @param {object} msg
 * @return {function}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">attachListener</span><span class="params">(msg, listener)</span> {</span>
  <span class="keyword">var</span> attached = msg.__onFinished
  <span class="keyword">var</span> socket = msg.socket

  <span class="comment">// create a private single listener with queue</span>
  <span class="keyword">if</span> (!attached || !attached.queue) {
    attached = msg.__onFinished = createListener(msg)

    <span class="comment">// finished on first event</span>
    first([
      [socket, <span class="string">'error'</span>, <span class="string">'close'</span>],
      [msg, <span class="string">'end'</span>, <span class="string">'finish'</span>],
    ], attached)
  }

  attached.queue.push(listener)
}

<span class="comment">/**
 * Create listener on message.
 *
 * @param {object} msg
 * @return {function}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">createListener</span><span class="params">(msg)</span> {</span>
  <span class="function"><span class="keyword">function</span> <span class="title">listener</span><span class="params">(err)</span> {</span>
    <span class="keyword">if</span> (msg.__onFinished === listener) msg.__onFinished = <span class="literal">null</span>
    <span class="keyword">if</span> (!listener.queue) <span class="keyword">return</span>

    <span class="keyword">var</span> queue = listener.queue
    listener.queue = <span class="literal">null</span>

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; queue.length; i++) {
      queue[i](err)
    }
  }

  listener.queue = []

  <span class="keyword">return</span> listener
}
</code></pre>