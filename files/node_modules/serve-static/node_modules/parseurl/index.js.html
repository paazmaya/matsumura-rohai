<h1>parseurl</h1>
<pre><code class="lang-js"><span class="comment">/*!
 * parseurl
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */</span>

<span class="comment">/**
 * Module dependencies.
 */</span>

<span class="keyword">var</span> url = require(<span class="string">'url'</span>)
<span class="keyword">var</span> parse = url.parse
<span class="keyword">var</span> Url = url.Url

<span class="comment">/**
 * Pattern for a simple path case.
 * See: https://github.com/joyent/node/pull/7878
 */</span>

<span class="keyword">var</span> simplePathRegExp = <span class="regexp">/^(\/\/?(?!\/)[^\?#\s]*)(\?[^#\s]*)?$/</span>

<span class="comment">/**
 * Exports.
 */</span>

module.exports = parseurl
module.exports.original = originalurl

<span class="comment">/**
 * Parse the `req` url with memoization.
 *
 * @param {ServerRequest} req
 * @return {Object}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">parseurl</span><span class="params">(req)</span> {</span>
  <span class="keyword">var</span> url = req.url

  <span class="keyword">if</span> (url === <span class="literal">undefined</span>) {
    <span class="comment">// URL is undefined</span>
    <span class="keyword">return</span> <span class="literal">undefined</span>
  }

  <span class="keyword">var</span> parsed = req._parsedUrl

  <span class="keyword">if</span> (fresh(url, parsed)) {
    <span class="comment">// Return cached URL parse</span>
    <span class="keyword">return</span> parsed
  }

  <span class="comment">// Parse the URL</span>
  parsed = fastparse(url)
  parsed._raw = url

  <span class="keyword">return</span> req._parsedUrl = parsed
};

<span class="comment">/**
 * Parse the `req` original url with fallback and memoization.
 *
 * @param {ServerRequest} req
 * @return {Object}
 * @api public
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">originalurl</span><span class="params">(req)</span> {</span>
  <span class="keyword">var</span> url = req.originalUrl

  <span class="keyword">if</span> (<span class="keyword">typeof</span> url !== <span class="string">'string'</span>) {
    <span class="comment">// Fallback</span>
    <span class="keyword">return</span> parseurl(req)
  }

  <span class="keyword">var</span> parsed = req._parsedOriginalUrl

  <span class="keyword">if</span> (fresh(url, parsed)) {
    <span class="comment">// Return cached URL parse</span>
    <span class="keyword">return</span> parsed
  }

  <span class="comment">// Parse the URL</span>
  parsed = fastparse(url)
  parsed._raw = url

  <span class="keyword">return</span> req._parsedOriginalUrl = parsed
};

<span class="comment">/**
 * Parse the `str` url with fast-path short-cut.
 *
 * @param {string} str
 * @return {Object}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">fastparse</span><span class="params">(str)</span> {</span>
  <span class="comment">// Try fast path regexp</span>
  <span class="comment">// See: https://github.com/joyent/node/pull/7878</span>
  <span class="keyword">var</span> simplePath = <span class="keyword">typeof</span> str === <span class="string">'string'</span> &amp;&amp; simplePathRegExp.exec(str)

  <span class="comment">// Construct simple URL</span>
  <span class="keyword">if</span> (simplePath) {
    <span class="keyword">var</span> pathname = simplePath[<span class="number">1</span>]
    <span class="keyword">var</span> search = simplePath[<span class="number">2</span>] || <span class="literal">null</span>
    <span class="keyword">var</span> url = Url !== <span class="literal">undefined</span>
      ? <span class="keyword">new</span> Url()
      : {}
    url.path = str
    url.href = str
    url.pathname = pathname
    url.search = search
    url.query = search &amp;&amp; search.substr(<span class="number">1</span>)

    <span class="keyword">return</span> url
  }

  <span class="keyword">return</span> parse(str)
}

<span class="comment">/**
 * Determine if parsed is still fresh for url.
 *
 * @param {string} url
 * @param {object} parsedUrl
 * @return {boolean}
 * @api private
 */</span>

<span class="function"><span class="keyword">function</span> <span class="title">fresh</span><span class="params">(url, parsedUrl)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">typeof</span> parsedUrl === <span class="string">'object'</span>
    &amp;&amp; parsedUrl !== <span class="literal">null</span>
    &amp;&amp; (Url === <span class="literal">undefined</span> || parsedUrl <span class="keyword">instanceof</span> Url)
    &amp;&amp; parsedUrl._raw === url
}
</code></pre>